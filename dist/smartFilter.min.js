var hcSmartFilter;(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilter:()=>n,SmartFilterCondition:()=>s,SmartFilterConditionType:()=>a,SmartFilterManager:()=>r,SmartFilterPropertyType:()=>o,getVersion:()=>l});class r{static _smartFilters=[];static initialize(e){r._viewer=e,r._smartFilters=[]}static addSmartFilter(e,t){r._smartFilters.push({filter:e,isProp:t})}static getSmartFilters(){return r._smartFilters}static getSmartFilterByName(e){for(let t=0;t<r._smartFilters.length;t++)if(r._smartFilters[t].filter.getName()==e)return r._smartFilters[t]}static getSmartFilterByID(e){for(let t=0;t<r._smartFilters.length;t++)if(r._smartFilters[t].filter._id==e)return r._smartFilters[t].filter}static getSmartFilterNum(){return r._smartFilters.length}static getSmartFilter(e){return r._smartFilters[e].filter}static getSmartFilterID(e){return r._smartFilters[e].filter._id}static getIsProp(e){return r._smartFilters[e].isProp}static removeSmartFilter(e){for(let t=0;t<r._smartFilters.length;t++)if(r._smartFilters[t].filter._id==e)return r._smartFilters.splice(t,1)}static updateSmartFilter(e,t){r._smartFilters[e].filter=t}static updateSmartFilterIsProp(e,t){for(let i=0;i<r._smartFilters.length;i++)r._smartFilters[i].filter._id==e&&(r._smartFilters[i].isProp=t)}static toJSON(){let e=[];for(let t=0;t<r._smartFilters.length;t++)e.push({filter:r._smartFilters[t].filter.toJSON(),isProp:r._smartFilters[t].isProp});return e}static fromJSON(e){r._smartFilters=[];for(let t=0;t<e.length;t++){let i=new n(r._viewer);i.fromJSON(e[t].filter),r.addSmartFilter(i,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let i=0;i<r._smartFilters.length;i++)if(r._smartFilters[i].isProp){let s=r._smartFilters[i].filter,a=!1;if(!s._keepSearchingChildren){let t=e;for(;t=r._viewer.model.getNodeParent(t),t!=r._viewer.model.getRootNode();)if(await s.testOneNodeAgainstConditions(t)){a=!0;break}}if(a)continue;if(await s.testOneNodeAgainstConditions(e)){let r=await s.findAllPropertiesOnNode(e),i=s.getName();""==i&&(i=s.generateString()),t.push({name:i,properties:r})}}return t}}class s{constructor(){this.and=!0,this.conditionType=a.contains,this.propertyType=o.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.smartFilterID=null}toJSON(){if(this.propertyType==o.smartFilter&&!this.smartFitlerID){let e=r.getSmartFilterByName(this.text);e&&(this.smartFilterID=e.filter._id)}return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,smartFilterID:this.smartFilterID}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.smartFilterID=e.smartFilterID}setSmartFilterID(e){this.smartFitlerID=e}getSmartFilterID(){return this.smartFilterID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}const a={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6,greaterOrEqualDate:7,lessOrEqualDate:8},o={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,smartFilter:7,nodeParent:8};class n{static _propertyHash=[];static _allPropertiesHash=[];static _containedInSpatialStructureHash=[];static _spaceBoundaryHash=[];static _modelHash=[];static convertEnumConditionToString(e){switch(e){case a.contains:return"contains";case a.exists:return"exists";case a.notExists:return"!exists";case a.greaterOrEqual:return">=";case a.lessOrEqual:return"<=";case a.greaterOrEqualDate:return">=(Date)";case a.lessOrEqualDate:return"<=(Date)";case a.equals:return"=";case a.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return a.contains;case"exists":return a.exists;case"!exists":return a.notExists;case">=":return a.greaterOrEqual;case"<=":return a.lessOrEqual;case"=":return a.equals;case"≠":return a.unequal;case">=(Date)":return a.greaterOrEqualDate;case"<=(Date)":return a.lessOrEqualDate}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SmartFilter")>-1)return o.smartFilter;switch(e){case"Node Name":return o.nodeName;case"Nodeid":return o.nodeId;case"Node Chain":return o.nodeChain;case"Node Type":return o.nodeType;case"Node Color":return o.nodeColor;case"Rel:ContainedIn":case"Rel:SpaceBoundary":return o.relationship;case"Smart Filter":return o.smartFilter;case"Node Parent":return o.nodeParent;default:return o.property}}static _getModelTreeIdsRecursive(e,t,r,i){t.push(i.model.getNodeProperties(e)),r.push(e);let s=i.model.getNodeChildren(e);for(let e=0;e<s.length;e++)n._getModelTreeIdsRecursive(s[e],t,r,i)}static addModel(e,t,r){for(let r=0;r<n._modelHash.length;r++)if(n._modelHash[r].id==e)return void(n._modelHash[r].nodeid=t);n._modelHash.push({id:e,nodeid:t,savedHash:r,ids:null,properties:null})}static _updateHashes(e,t,r,i){for(let s=0;s<r.length;s++){n._propertyHash[t[s]]=r[s];let a=e.model.getNodeLayerId(t[s]);if(null!=a&&i.size>1)if(null==n._propertyHash[t[s]]&&(n._propertyHash[t[s]]=[]),3==e.model.getNodeType(t[s])){let r=e.model.getNodeParent(t[s]);null==n._propertyHash[r]&&(n._propertyHash[r]=[]),n._propertyHash[r].LAYER=i.get(a)}else n._propertyHash[t[s]].LAYER=i.get(a);for(let e in r[s])n._allPropertiesHash[e]=[]}for(let e in n._propertyHash)for(let t in n._propertyHash[e])n._allPropertiesHash[t][n._propertyHash[e][t]]=!0}static parseSavedPropertyHash(e){let t=e.allprops,r=e.nodeprops,i=e.related,s=[],a=[];for(let e=0;e<r.length;e++){let i=r[e];a.push(i.i);let o={},n=i.p;for(let e=0;e<n.length;e+=2)o[t[n[e]].name]=t[n[e]].values[n[e+1]];s.push(o)}let o=[],n=[];if(i)for(let e=0;e<i.length;e++){let t=i[e];t.e?o[parseInt(t.i)]=t.e:o[parseInt(t.i)]=[],t.f?n[parseInt(t.i)]=t.f:n[parseInt(t.i)]=[]}return{ids:a,props:s,relatedSpaceBoundary:o,relatedContainedIn:n}}static gatherRelatedDataHashesRecursive(e,t,r){let i=e.model.getBimIdFromNode(t),s=e.model.getBimIdRelatingElements(t,i,Communicator.RelationshipType.SpaceBoundary),a={i:t},o=e.model.getBimIdRelatingElements(t,i,Communicator.RelationshipType.ContainedInSpatialStructure);s&&s.length>0&&(a.e=s),o&&o.length>0&&(a.f=o),r.push(a);let l=e.model.getNodeChildren(t);for(let t=0;t<l.length;t++)n.gatherRelatedDataHashesRecursive(e,l[t],r)}static exportPropertyHash(e){let t=[],r=[],i=[];for(let e in n._allPropertiesHash){let r={name:e,values:Object.keys(n._allPropertiesHash[e])},s=[];for(let e=0;e<r.values.length;e++)s[r.values[e]]=e;r.ehash=s,t.push(r),i[e]=t.length-1}for(let e in n._propertyHash){let s=[];for(let r in n._propertyHash[e]){let a=t[i[r]];s.push(i[r],a.ehash[n._propertyHash[e][r]])}r.push({i:e,p:s})}for(let e=0;e<t.length;e++)t[e].ehash=void 0;return n.gatherRelatedDataHashesRecursive(e,e.model.getRootNode(),[]),{allprops:t,nodeprops:r}}static _consolidateBodies(e){let t=[];for(let r in n._propertyHash)3==e.model.getNodeType(parseInt(r))&&n._propertyHash[r].Volume&&(t[e.model.getNodeParent(parseInt(r))]=!0);for(let r in t){let t=hwv.model.getNodeChildren(parseInt(r)),i=0,s=0;for(let e=0;e<t.length;e++){let r=t[e];n._propertyHash[r]&&n._propertyHash[r].Volume&&(i+=parseFloat(n._propertyHash[r].Volume)),n._propertyHash[r]&&n._propertyHash[r]["Surface Area"]&&(s+=parseFloat(n._propertyHash[r]["Surface Area"]))}if(i+="mm³",s+="mm²",n._propertyHash[r].Volume=i,n._propertyHash[r]["Surface Area"]=s,e.model.getNodeName(parseInt(r)).startsWith("Product")){let t=e.model.getNodeParent(parseInt(r));n._propertyHash[t].Volume=i,n._propertyHash[t]["Surface Area"]=s}}}static async initialize(e){n._propertyHash=[],n._allPropertiesHash=[],n._containedInSpatialStructureHash=[],n._spaceBoundaryHash=[];let t=e.model.getLayers();if(0==n._modelHash.length){let r=[],i=[];n._getModelTreeIdsRecursive(e.model.getRootNode(),r,i,e);let s=await Promise.all(r);n._updateHashes(e,i,s,t),n._consolidateBodies(e)}else for(let r=0;r<n._modelHash.length;r++){let i=n._modelHash[r],s=[],a=null,o=e.model.getNodeIdOffset(i.nodeid);if(i.ids){for(let e=0;e<i.ids.length;e++)s.push(i.ids[e]+o);a=i.properties}else{let t=[];if(i.savedHash){let e=n.parseSavedPropertyHash(i.savedHash);a=e.props,s=e.ids,n._containedInSpatialStructureHash=e.relatedContainedIn,n._spaceBoundaryHash=e.relatedSpaceBoundary}else n._getModelTreeIdsRecursive(i.nodeid,t,s,e),a=await Promise.all(t);i.properties=a,i.ids=[];for(let e=0;e<s.length;e++)i.ids.push(s[e]-o)}n._updateHashes(e,s,a,t)}}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._keepSearchingChildren=!1,this._id=this._generateGUID(),this._startnode=t||this._viewer.model.getRootNode()}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}updateConditions(e){this._conditions=e}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){this._conditions.splice(e,1)}getAllProperties(){let e=[],t=!1;n._allPropertiesHash.TYPE&&(t=!0);for(let t in n._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e.unshift("Smart Filter"),e.unshift("Rel:SpaceBoundary"),e.unshift("Rel:ContainedIn"),e.unshift("Node Color"),e.unshift("Node Type"),e.unshift("Node Chain"),e.unshift("Node Parent"),e.unshift("Nodeid"),e.unshift("Node Name"),e}getAllOptionsForProperty(e){return n._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let r=new s;r.fromJSON(e.conditions[t]),this._conditions.push(r)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new n(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name,null==e.keepSearchingChildren?this._keepSearchingChildren=!1:this._keepSearchingChildren=e.keepSearchingChildren,e.id&&(this._id=e.id)}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let r=this._conditions[t].toJSON();this._conditions[t].childFilter&&(r.childFilter=this._conditions[t].childFilter.toJSON()),e.push(r)}return{conditions:e,name:this._name,id:this._id,keepSearchingChildren:this._keepSearchingChildren}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let r=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._startnode,""):await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._viewer.model.getNodeParent(this._startnode),"");else for(let i=0;i<t.length;i++)await this._gatherMatchingNodesRecursive(e,t[i],r,this._viewer.model.getNodeParent(t[i]),"");return r}createChainText(e,t,r){let i=e,s=[];for(;;){let e=this._viewer.model.getNodeParent(i);if(null==e||e==t)break;s.push(this._viewer.model.getNodeName(e)),i=e}let a="";for(let e=r;e<s.length;e++)e<s.length-1?a+=s[e]+"->":a+=s[e];return a}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions,"")}async findAllPropertiesOnNode(e,t,r,i){let s,a,l;t?(s=t,a=r,l=i):(s=this._conditions,a=[],l=[]);for(let t=0;t<s.length;t++)if(s[t].childFilter)await this.findAllPropertiesOnNode(e,s[t].childFilter._conditions,a,l);else if(s[t].propertyType==o.property){let r=n._propertyHash[e];r[s[t].propertyName]&&!l[s[t].propertyName]&&(l[s[t].propertyName]=!0,a.push({name:s[t].propertyName,value:r[s[t].propertyName]}))}return a}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+n.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryFilter(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(n._spaceBoundaryHash[e]?r=n._spaceBoundaryHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.SpaceBoundary),n._spaceBoundaryHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),a="";for(let e=0;e<r.length;e++)a+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkFilter(parseInt(r[i])+s,t,a))return!0}return!1}async _checkContainedInFilter(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(n._containedInSpatialStructureHash[e]?r=n._containedInSpatialStructureHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.ContainedInSpatialStructure),n._containedInSpatialStructureHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),a="";for(let e=0;e<r.length;e++)a+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkFilter(parseInt(r[i])+s,t,a))return!0}return!1}async _checkFilter(e,t,r){if(t.conditionType!=a.contains){if(t.conditionType==a.exists)return!(!n._propertyHash[e]||null==n._propertyHash[e][t.propertyName]);if(t.conditionType==a.notExists)return!(!n._propertyHash[e]||null!=n._propertyHash[e][t.propertyName]);let r;if(t.propertyType==o.nodeName)r=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==o.nodeId)r=e;else{let i;if(n._propertyHash[e]&&(i=n._propertyHash[e][t.propertyName]),null==i)return t.conditionType==a.unequal;r=parseFloat(i)}if(t.conditionType==a.greaterOrEqualDate||t.conditionType==a.lessOrEqualDate){let r;if(n._propertyHash[e]&&(r=n._propertyHash[e][t.propertyName]),null==r)return!1;isNaN(parseInt(r))||(r=parseInt(r));let i=new Date(r);if(isNaN(i.getDate()))return!1;let s=t.text;isNaN(parseInt(s))||(s=parseInt(s));let o=new Date(s);if(t.conditionType==a.greaterOrEqualDate){if(i>=o)return!0}else if(t.conditionType==a.lessOrEqualDate&&i<=o)return!0;return!1}{let e=parseFloat(t.text);if(isNaN(e)||isNaN(r))return!1;if(t.conditionType==a.greaterOrEqual){if(r>=e)return!0}else if(t.conditionType==a.lessOrEqual){if(r<=e)return!0}else if(t.conditionType==a.unequal){if(r!=e)return!0}else if(r==e)return!0;return!1}}{let i=t.text.split(","),s="";if(t.propertyType==o.nodeName)s=this._viewer.model.getNodeName(e);else if(t.propertyType==o.relationship)s=r;else if(t.propertyType==o.nodeChain)s=r||this.createChainText(e,this._viewer.model.getRootNode(),0);else if(t.propertyType==o.nodeParent)s=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(e));else if(t.propertyType==o.nodeType)s=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==o.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)s="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);s=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else s=t.propertyType==o.nodeId?e.toString():null==n._propertyHash[e]||null==n._propertyHash[e][t.propertyName]?void 0:n._propertyHash[e][t.propertyName];null==s&&(s="");let a=0,l=0,d=0,h=0,p=0;for(let e=0;e<i.length;e++){let r,n;if('"'==i[e][0]||'"'==i[e][1])if(r=!0,'"'==i[e][0])n=i[e].substring(1,i[e].length-1);else{let t=i[e][0];n=i[e].substring(2,i[e].length-1),n=t+n}else n=i[e],r=!1;if(t.propertyType==o.nodeId&&(r=!0),""==n||1==n.length&&("+"==n[0]||"-"==n[0]))return;"+"==n[0]?(l++,r?s.toLowerCase()==n.substring(1).toLowerCase()&&a++:-1!=s.toLowerCase().indexOf(n.substring(1).toLowerCase())&&a++):"-"==n[0]?(d++,r?s.toLowerCase()!=n.substring(1).toLowerCase()&&h++:-1==s.toLowerCase().indexOf(n.substring(1).toLowerCase())&&h++):r?s.toLowerCase()==n.toLowerCase()&&p++:-1!=s.toLowerCase().indexOf(n.toLowerCase())&&p++}return l==a&&d==h&&(p>0||a+h==i.length)}}async _testNodeAgainstConditions(e,t,i){let s=0,a=!1;t.length>1&&!t[1].and&&(a=!0);for(let n=0;n<t.length;n++){let l;if(t[n].propertyType==o.relationship)"Rel:SpaceBoundary"==t[n].propertyName?l=await this._checkSpaceBoundaryFilter(e,t[n]):"Rel:ContainedIn"==t[n].propertyName&&(l=await this._checkContainedInFilter(e,t[n]));else if(t[n].propertyType==o.smartFilter){if(!t[n].smartFilter)if(t[n].smartFilterID)t[n].smartFilter=r.getSmartFilterByID(t[n].smartFilterID);else{let e=r.getSmartFilterByName(t[n].text);t[n].smartFilterID=e.filter._id,t[n].smartFilter=e.filter}l=await this._testNodeAgainstConditions(e,t[n].smartFilter._conditions,i)}else l=t[n].childFilter?await this._testNodeAgainstConditions(e,t[n].childFilter._conditions,i):await this._checkFilter(e,t[n],i);if(0==l){if(!a)break}else s++}return!!(!a&&s==t.length||a&&s>0)}async _gatherMatchingNodesRecursive(e,t,r,i,s){let a=this._viewer.model.getNodeName(t);if(t!=i&&await this._testNodeAgainstConditions(t,e,s)&&(r.push(t),!this._keepSearchingChildren))return;let o=this._viewer.model.getNodeChildren(t);for(let t=0;t<o.length;t++)await this._gatherMatchingNodesRecursive(e,o[t],r,i,s+a)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}function l(){return"1.0.3"}hcSmartFilter=t})();