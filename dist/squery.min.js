var hcSQuery;(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SQuery:()=>a,SQueryCondition:()=>s,SQueryConditionType:()=>o,SQueryManager:()=>r,SQueryPropertyType:()=>n,getVersion:()=>l});class r{static _SQuerys=[];static initialize(e){r._viewer=e,r._SQuerys=[]}static addSQuery(e,t){r._SQuerys.push({filter:e,isProp:t})}static getSQuerys(){return r._SQuerys}static getSQueryByName(e){for(let t=0;t<r._SQuerys.length;t++)if(r._SQuerys[t].filter.getName()==e)return r._SQuerys[t]}static getSQueryByID(e){for(let t=0;t<r._SQuerys.length;t++)if(r._SQuerys[t].filter._id==e)return r._SQuerys[t].filter}static getSQueryNum(){return r._SQuerys.length}static getSQuery(e){return r._SQuerys[e].filter}static getSQueryID(e){return r._SQuerys[e].filter._id}static getIsProp(e){return r._SQuerys[e].isProp}static removeSQuery(e){for(let t=0;t<r._SQuerys.length;t++)if(r._SQuerys[t].filter._id==e)return r._SQuerys.splice(t,1)}static updateSQuery(e,t){r._SQuerys[e].filter=t}static updateSQueryIsProp(e,t){for(let i=0;i<r._SQuerys.length;i++)r._SQuerys[i].filter._id==e&&(r._SQuerys[i].isProp=t)}static toJSON(){let e=[];for(let t=0;t<r._SQuerys.length;t++)e.push({filter:r._SQuerys[t].filter.toJSON(),isProp:r._SQuerys[t].isProp});return e}static fromJSON(e){r._SQuerys=[];for(let t=0;t<e.length;t++){let i=new a(r._viewer);i.fromJSON(e[t].filter),r.addSQuery(i,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let i=0;i<r._SQuerys.length;i++)if(r._SQuerys[i].isProp){let s=r._SQuerys[i].filter,o=!1;if(!s._keepSearchingChildren){let t=e;for(;t=r._viewer.model.getNodeParent(t),t!=r._viewer.model.getRootNode();)if(await s.testOneNodeAgainstConditions(t)){o=!0;break}}if(o)continue;if(await s.testOneNodeAgainstConditions(e)){let r=await s.findAllPropertiesOnNode(e),i=s.getName();""==i&&(i=s.generateString()),t.push({name:i,properties:r})}}return t}}class s{constructor(){this.and=!0,this.conditionType=o.contains,this.propertyType=n.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.SQueryID=null}toJSON(){if(this.propertyType==n.SQuery&&!this.squeryFitlerID){let e=r.getSQueryByName(this.text);e&&(this.SQueryID=e.filter._id)}return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,SQueryID:this.SQueryID}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.SQueryID=e.SQueryID}setSQueryID(e){this.squeryFitlerID=e}getSQueryID(){return this.SQueryID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}const o={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6,greaterOrEqualDate:7,lessOrEqualDate:8},n={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,SQuery:7,nodeParent:8};class a{static _propertyHash=[];static _allPropertiesHash=[];static _containedInSpatialStructureHash=[];static _spaceBoundaryHash=[];static _modelHash=[];static convertEnumConditionToString(e){switch(e){case o.contains:return"contains";case o.exists:return"exists";case o.notExists:return"!exists";case o.greaterOrEqual:return">=";case o.lessOrEqual:return"<=";case o.greaterOrEqualDate:return">=(Date)";case o.lessOrEqualDate:return"<=(Date)";case o.equals:return"=";case o.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return o.contains;case"exists":return o.exists;case"!exists":return o.notExists;case">=":return o.greaterOrEqual;case"<=":return o.lessOrEqual;case"=":return o.equals;case"≠":return o.unequal;case">=(Date)":return o.greaterOrEqualDate;case"<=(Date)":return o.lessOrEqualDate}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SQuery")>-1)return n.SQuery;switch(e){case"Node Name":return n.nodeName;case"Nodeid":return n.nodeId;case"Node Chain":return n.nodeChain;case"Node Type":return n.nodeType;case"Node Color":return n.nodeColor;case"Rel:ContainedIn":case"Rel:SpaceBoundary":return n.relationship;case"Smart Filter":return n.SQuery;case"Node Parent":return n.nodeParent;default:return n.property}}static _getModelTreeIdsRecursive(e,t,r,i){t.push(i.model.getNodeProperties(e)),r.push(e);let s=i.model.getNodeChildren(e);for(let e=0;e<s.length;e++)a._getModelTreeIdsRecursive(s[e],t,r,i)}static addModel(e,t,r){for(let r=0;r<a._modelHash.length;r++)if(a._modelHash[r].id==e)return void(a._modelHash[r].nodeid=t);a._modelHash.push({id:e,nodeid:t,savedHash:r,ids:null,properties:null})}static _updateHashes(e,t,r,i){for(let s=0;s<r.length;s++){a._propertyHash[t[s]]=r[s];let o=e.model.getNodeLayerId(t[s]);if(null!=o&&i.size>1)if(null==a._propertyHash[t[s]]&&(a._propertyHash[t[s]]=[]),3==e.model.getNodeType(t[s])){let r=e.model.getNodeParent(t[s]);null==a._propertyHash[r]&&(a._propertyHash[r]=[]),a._propertyHash[r].LAYER=i.get(o)}else a._propertyHash[t[s]].LAYER=i.get(o);for(let e in r[s])a._allPropertiesHash[e]=[]}for(let e in a._propertyHash)for(let t in a._propertyHash[e])a._allPropertiesHash[t][a._propertyHash[e][t]]=!0}static parseSavedPropertyHash(e){let t=e.allprops,r=e.nodeprops,i=e.related,s=[],o=[];for(let e=0;e<r.length;e++){let i=r[e];o.push(i.i);let n={},a=i.p;for(let e=0;e<a.length;e+=2)n[t[a[e]].name]=t[a[e]].values[a[e+1]];s.push(n)}let n=[],a=[];if(i)for(let e=0;e<i.length;e++){let t=i[e];t.e?n[parseInt(t.i)]=t.e:n[parseInt(t.i)]=[],t.f?a[parseInt(t.i)]=t.f:a[parseInt(t.i)]=[]}return{ids:o,props:s,relatedSpaceBoundary:n,relatedContainedIn:a}}static gatherRelatedDataHashesRecursive(e,t,r){let i=e.model.getBimIdFromNode(t),s=e.model.getBimIdRelatingElements(t,i,Communicator.RelationshipType.SpaceBoundary),o={i:t},n=e.model.getBimIdRelatingElements(t,i,Communicator.RelationshipType.ContainedInSpatialStructure);s&&s.length>0&&(o.e=s),n&&n.length>0&&(o.f=n),r.push(o);let l=e.model.getNodeChildren(t);for(let t=0;t<l.length;t++)a.gatherRelatedDataHashesRecursive(e,l[t],r)}static exportPropertyHash(e){let t=[],r=[],i=[];for(let e in a._allPropertiesHash){let r={name:e,values:Object.keys(a._allPropertiesHash[e])},s=[];for(let e=0;e<r.values.length;e++)s[r.values[e]]=e;r.ehash=s,t.push(r),i[e]=t.length-1}for(let e in a._propertyHash){let s=[];for(let r in a._propertyHash[e]){let o=t[i[r]];s.push(i[r],o.ehash[a._propertyHash[e][r]])}r.push({i:e,p:s})}for(let e=0;e<t.length;e++)t[e].ehash=void 0;return a.gatherRelatedDataHashesRecursive(e,e.model.getRootNode(),[]),{allprops:t,nodeprops:r}}static _consolidateBodies(e){let t=[];for(let r in a._propertyHash)3==e.model.getNodeType(parseInt(r))&&a._propertyHash[r].Volume&&(t[e.model.getNodeParent(parseInt(r))]=!0);for(let r in t){let t=hwv.model.getNodeChildren(parseInt(r)),i=0,s=0;for(let e=0;e<t.length;e++){let r=t[e];a._propertyHash[r]&&a._propertyHash[r].Volume&&(i+=parseFloat(a._propertyHash[r].Volume)),a._propertyHash[r]&&a._propertyHash[r]["Surface Area"]&&(s+=parseFloat(a._propertyHash[r]["Surface Area"]))}if(i+="mm³",s+="mm²",a._propertyHash[r].Volume=i,a._propertyHash[r]["Surface Area"]=s,e.model.getNodeName(parseInt(r)).startsWith("Product")){let t=e.model.getNodeParent(parseInt(r));a._propertyHash[t].Volume=i,a._propertyHash[t]["Surface Area"]=s}}}static async initialize(e){a._propertyHash=[],a._allPropertiesHash=[],a._containedInSpatialStructureHash=[],a._spaceBoundaryHash=[];let t=e.model.getLayers();if(0==a._modelHash.length){let r=[],i=[];a._getModelTreeIdsRecursive(e.model.getRootNode(),r,i,e);let s=await Promise.all(r);a._updateHashes(e,i,s,t),a._consolidateBodies(e)}else for(let r=0;r<a._modelHash.length;r++){let i=a._modelHash[r],s=[],o=null,n=e.model.getNodeIdOffset(i.nodeid);if(i.ids){for(let e=0;e<i.ids.length;e++)s.push(i.ids[e]+n);o=i.properties}else{let t=[];if(i.savedHash){let e=a.parseSavedPropertyHash(i.savedHash);o=e.props,s=e.ids,a._containedInSpatialStructureHash=e.relatedContainedIn,a._spaceBoundaryHash=e.relatedSpaceBoundary}else a._getModelTreeIdsRecursive(i.nodeid,t,s,e),o=await Promise.all(t);i.properties=o,i.ids=[];for(let e=0;e<s.length;e++)i.ids.push(s[e]-n)}a._updateHashes(e,s,o,t)}}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._keepSearchingChildren=!1,this._id=this._generateGUID(),this._startnode=t||this._viewer.model.getRootNode()}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}updateConditions(e){this._conditions=e}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){this._conditions.splice(e,1)}getAllProperties(){let e=[],t=!1;a._allPropertiesHash.TYPE&&(t=!0);for(let t in a._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e.unshift("Smart Filter"),e.unshift("Rel:SpaceBoundary"),e.unshift("Rel:ContainedIn"),e.unshift("Node Color"),e.unshift("Node Type"),e.unshift("Node Chain"),e.unshift("Node Parent"),e.unshift("Nodeid"),e.unshift("Node Name"),e}getAllOptionsForProperty(e){return a._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let r=new s;r.fromJSON(e.conditions[t]),this._conditions.push(r)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new a(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name,null==e.keepSearchingChildren?this._keepSearchingChildren=!1:this._keepSearchingChildren=e.keepSearchingChildren,e.id&&(this._id=e.id)}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let r=this._conditions[t].toJSON();this._conditions[t].childFilter&&(r.childFilter=this._conditions[t].childFilter.toJSON()),e.push(r)}return{conditions:e,name:this._name,id:this._id,keepSearchingChildren:this._keepSearchingChildren}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let r=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._startnode,""):await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._viewer.model.getNodeParent(this._startnode),"");else for(let i=0;i<t.length;i++)await this._gatherMatchingNodesRecursive(e,t[i],r,this._viewer.model.getNodeParent(t[i]),"");return r}createChainText(e,t,r){let i=e,s=[];for(;;){let e=this._viewer.model.getNodeParent(i);if(null==e||e==t)break;s.push(this._viewer.model.getNodeName(e)),i=e}let o="";for(let e=r;e<s.length;e++)e<s.length-1?o+=s[e]+"->":o+=s[e];return o}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions,"")}async findAllPropertiesOnNode(e,t,r,i){let s,o,l;t?(s=t,o=r,l=i):(s=this._conditions,o=[],l=[]);for(let t=0;t<s.length;t++)if(s[t].childFilter)await this.findAllPropertiesOnNode(e,s[t].childFilter._conditions,o,l);else if(s[t].propertyType==n.property){let r=a._propertyHash[e];r[s[t].propertyName]&&!l[s[t].propertyName]&&(l[s[t].propertyName]=!0,o.push({name:s[t].propertyName,value:r[s[t].propertyName]}))}return o}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+a.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryFilter(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(a._spaceBoundaryHash[e]?r=a._spaceBoundaryHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.SpaceBoundary),a._spaceBoundaryHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),o="";for(let e=0;e<r.length;e++)o+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkFilter(parseInt(r[i])+s,t,o))return!0}return!1}async _checkContainedInFilter(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(a._containedInSpatialStructureHash[e]?r=a._containedInSpatialStructureHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.ContainedInSpatialStructure),a._containedInSpatialStructureHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),o="";for(let e=0;e<r.length;e++)o+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkFilter(parseInt(r[i])+s,t,o))return!0}return!1}async _checkFilter(e,t,r){if(t.conditionType!=o.contains){if(t.conditionType==o.exists)return!(!a._propertyHash[e]||null==a._propertyHash[e][t.propertyName]);if(t.conditionType==o.notExists)return!(!a._propertyHash[e]||null!=a._propertyHash[e][t.propertyName]);let r;if(t.propertyType==n.nodeName)r=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==n.nodeId)r=e;else{let i;if(a._propertyHash[e]&&(i=a._propertyHash[e][t.propertyName]),null==i)return t.conditionType==o.unequal;r=parseFloat(i)}if(t.conditionType==o.greaterOrEqualDate||t.conditionType==o.lessOrEqualDate){let r;if(a._propertyHash[e]&&(r=a._propertyHash[e][t.propertyName]),null==r)return!1;isNaN(parseInt(r))||(r=parseInt(r));let i=new Date(r);if(isNaN(i.getDate()))return!1;let s=t.text;isNaN(parseInt(s))||(s=parseInt(s));let n=new Date(s);if(t.conditionType==o.greaterOrEqualDate){if(i>=n)return!0}else if(t.conditionType==o.lessOrEqualDate&&i<=n)return!0;return!1}{let e=parseFloat(t.text);if(isNaN(e)||isNaN(r))return!1;if(t.conditionType==o.greaterOrEqual){if(r>=e)return!0}else if(t.conditionType==o.lessOrEqual){if(r<=e)return!0}else if(t.conditionType==o.unequal){if(r!=e)return!0}else if(r==e)return!0;return!1}}{let i=t.text.split(","),s="";if(t.propertyType==n.nodeName)s=this._viewer.model.getNodeName(e);else if(t.propertyType==n.relationship)s=r;else if(t.propertyType==n.nodeChain)s=r||this.createChainText(e,this._viewer.model.getRootNode(),0);else if(t.propertyType==n.nodeParent)s=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(e));else if(t.propertyType==n.nodeType)s=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==n.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)s="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);s=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else s=t.propertyType==n.nodeId?e.toString():null==a._propertyHash[e]||null==a._propertyHash[e][t.propertyName]?void 0:a._propertyHash[e][t.propertyName];null==s&&(s="");let o=0,l=0,d=0,h=0,p=0;for(let e=0;e<i.length;e++){let r,a;if('"'==i[e][0]||'"'==i[e][1])if(r=!0,'"'==i[e][0])a=i[e].substring(1,i[e].length-1);else{let t=i[e][0];a=i[e].substring(2,i[e].length-1),a=t+a}else a=i[e],r=!1;if(t.propertyType==n.nodeId&&(r=!0),""==a||1==a.length&&("+"==a[0]||"-"==a[0]))return;"+"==a[0]?(l++,r?s.toLowerCase()==a.substring(1).toLowerCase()&&o++:-1!=s.toLowerCase().indexOf(a.substring(1).toLowerCase())&&o++):"-"==a[0]?(d++,r?s.toLowerCase()!=a.substring(1).toLowerCase()&&h++:-1==s.toLowerCase().indexOf(a.substring(1).toLowerCase())&&h++):r?s.toLowerCase()==a.toLowerCase()&&p++:-1!=s.toLowerCase().indexOf(a.toLowerCase())&&p++}return l==o&&d==h&&(p>0||o+h==i.length)}}async _testNodeAgainstConditions(e,t,i){let s=0,o=!1;t.length>1&&!t[1].and&&(o=!0);for(let a=0;a<t.length;a++){let l;if(t[a].propertyType==n.relationship)"Rel:SpaceBoundary"==t[a].propertyName?l=await this._checkSpaceBoundaryFilter(e,t[a]):"Rel:ContainedIn"==t[a].propertyName&&(l=await this._checkContainedInFilter(e,t[a]));else if(t[a].propertyType==n.SQuery){if(!t[a].SQuery)if(t[a].SQueryID)t[a].SQuery=r.getSQueryByID(t[a].SQueryID);else{let e=r.getSQueryByName(t[a].text);t[a].SQueryID=e.filter._id,t[a].SQuery=e.filter}l=await this._testNodeAgainstConditions(e,t[a].SQuery._conditions,i)}else l=t[a].childFilter?await this._testNodeAgainstConditions(e,t[a].childFilter._conditions,i):await this._checkFilter(e,t[a],i);if(0==l){if(!o)break}else s++}return!!(!o&&s==t.length||o&&s>0)}async _gatherMatchingNodesRecursive(e,t,r,i,s){let o=this._viewer.model.getNodeName(t);if(t!=i&&await this._testNodeAgainstConditions(t,e,s)&&(r.push(t),!this._keepSearchingChildren))return;let n=this._viewer.model.getNodeChildren(t);for(let t=0;t<n.length;t++)await this._gatherMatchingNodesRecursive(e,n[t],r,i,s+o)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}function l(){return"1.0.3"}hcSQuery=t})();