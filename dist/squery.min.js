var hcSQuery;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SQuery:()=>o,SQueryCondition:()=>n,SQueryConditionType:()=>r,SQueryManager:()=>a,SQueryPropertyType:()=>s,getVersion:()=>h});const r={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6,greaterOrEqualDate:7,lessOrEqualDate:8},s={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,SQuery:7,nodeParent:8};class n{static convertEnumConditionToString(e){switch(e){case r.contains:return"contains";case r.exists:return"exists";case r.notExists:return"!exists";case r.greaterOrEqual:return">=";case r.lessOrEqual:return"<=";case r.greaterOrEqualDate:return">=(Date)";case r.lessOrEqualDate:return"<=(Date)";case r.equals:return"=";case r.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return r.contains;case"exists":return r.exists;case"!exists":return r.notExists;case">=":return r.greaterOrEqual;case"<=":return r.lessOrEqual;case"=":return r.equals;case"≠":return r.unequal;case">=(Date)":return r.greaterOrEqualDate;case"<=(Date)":return r.lessOrEqualDate}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SQuery")>-1)return s.SQuery;switch(e){case"Node Name":return s.nodeName;case"Nodeid":return s.nodeId;case"Node Chain":return s.nodeChain;case"Node Type":return s.nodeType;case"Node Color":return s.nodeColor;case"Rel:ContainedIn":case"Rel:SpaceBoundary":return s.relationship;case"SQuery":return s.SQuery;case"Node Parent":return s.nodeParent;default:return s.property}}constructor(){this.and=!0,this.conditionType=r.contains,this.propertyType=s.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.SQueryID=null}toJSON(e){if(this.propertyType==s.SQuery&&!this.squeryFitlerID){let t=e.getSQueryByName(this.text);t&&(this.SQueryID=t.filter._id)}return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,SQueryID:this.SQueryID}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.SQueryID=e.SQueryID}setSQueryID(e){this.squeryFitlerID=e}getSQueryID(){return this.SQueryID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}class o{constructor(e,t){this._manager=e,this._viewer=this._manager._viewer,this._limitselectionlist=[],this._conditions=[],this._name="",this._keepSearchingChildren=!1,this._id=this._generateGUID(),this._startnode=t||this._viewer.model.getRootNode()}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}updateConditions(e){this._conditions=e}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){if(1==this._conditions.length&&this._conditions[0].childFilter){let e=this._conditions[0].childFilter;this._conditions.splice(0,1);for(let t=0;t<e._conditions.length;t++)this._conditions.unshift(e._conditions[t])}else this._conditions.splice(e,1)}getAllOptionsForProperty(e){return this._manager._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let i=new n;i.fromJSON(e.conditions[t]),this._conditions.push(i)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new o(this._manager,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name,null==e.keepSearchingChildren?this._keepSearchingChildren=!1:this._keepSearchingChildren=e.keepSearchingChildren,e.id&&(this._id=e.id)}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let i=this._conditions[t].toJSON(this._manager);this._conditions[t].childFilter&&(i.childFilter=this._conditions[t].childFilter.toJSON()),e.push(i)}return{conditions:e,name:this._name,id:this._id,keepSearchingChildren:this._keepSearchingChildren}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let i=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._startnode,""):await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._viewer.model.getNodeParent(this._startnode),"");else for(let r=0;r<t.length;r++)await this._gatherMatchingNodesRecursive(e,t[r],i,this._viewer.model.getNodeParent(t[r]),"");return i}createChainText(e,t,i){let r=e,s=[];for(;;){let e=this._viewer.model.getNodeParent(r);if(null==e||e==t)break;s.push(this._viewer.model.getNodeName(e)),r=e}let n="";for(let e=s.length-1-i;e>=0;e--)n+=e>0?s[e]+"->":s[e];return n}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions,"")}async findAllPropertiesOnNode(e,t,i,r){let n,o,a;t?(n=t,o=i,a=r):(n=this._conditions,o=[],a=[]);for(let t=0;t<n.length;t++)if(n[t].childFilter)await this.findAllPropertiesOnNode(e,n[t].childFilter._conditions,o,a);else if(n[t].propertyType==s.property){let i=this._manager._propertyHash[e];i[n[t].propertyName]&&!a[n[t].propertyName]&&(a[n[t].propertyName]=!0,o.push({name:n[t].propertyName,value:i[n[t].propertyName]}))}return o}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+n.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryCondition(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(this._manager._spaceBoundaryHash[e]?r=this._manager._spaceBoundaryHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.SpaceBoundary),this._manager._spaceBoundaryHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),n="";for(let e=0;e<r.length;e++)n+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkCondition(parseInt(r[i])+s,t,n))return!0}return!1}async _checkContainedInCondition(e,t){let r,s=this._viewer.model.getBimIdFromNode(e);if(this._manager._containedInSpatialStructureHash[e]?r=this._manager._containedInSpatialStructureHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,s,Communicator.RelationshipType.ContainedInSpatialStructure),this._manager._containedInSpatialStructureHash[e]=r),r.length>0){let s=this._viewer.model.getNodeIdOffset(e),n="";for(let e=0;e<r.length;e++)n+=this._viewer.model.getNodeName(parseInt(r[e])+s);if(await this._checkCondition(parseInt(r[i])+s,t,n))return!0}return!1}async _checkCondition(e,t,i){if(t.conditionType!=r.contains){if(t.conditionType==r.exists)return!(!this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]);if(t.conditionType==r.notExists)return!(!this._manager._propertyHash[e]||null!=this._manager._propertyHash[e][t.propertyName]);let i;if(t.propertyType==s.nodeName)i=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==s.nodeId)i=e;else{let s;if(this._manager._propertyHash[e]&&(s=this._manager._propertyHash[e][t.propertyName]),null==s)return t.conditionType==r.unequal;i=parseFloat(s)}if(t.conditionType==r.greaterOrEqualDate||t.conditionType==r.lessOrEqualDate){let i;if(this._manager._propertyHash[e]&&(i=this._manager._propertyHash[e][t.propertyName]),null==i)return!1;-1!=i.indexOf(" ")||isNaN(parseInt(i))||(i=parseInt(i));let s=new Date(i);if(isNaN(s.getDate()))return!1;let n=t.text;-1!=n.indexOf(" ")||isNaN(parseInt(n))||(n=parseInt(n));let o=new Date(n);if(t.conditionType==r.greaterOrEqualDate){if(s>=o)return!0}else if(t.conditionType==r.lessOrEqualDate&&s<=o)return!0;return!1}{let e=parseFloat(t.text);if(isNaN(e)||isNaN(i))return!1;if(t.conditionType==r.greaterOrEqual){if(i>=e)return!0}else if(t.conditionType==r.lessOrEqual){if(i<=e)return!0}else if(t.conditionType==r.unequal){if(i!=e)return!0}else if(i==e)return!0;return!1}}{let r=t.text.split(","),n="";if(t.propertyType==s.nodeName)n=this._viewer.model.getNodeName(e);else if(t.propertyType==s.relationship)n=i;else if(t.propertyType==s.nodeChain)n=i||this.createChainText(e,this._viewer.model.getRootNode(),0);else if(t.propertyType==s.nodeParent)n=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(e));else if(t.propertyType==s.nodeType)n=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==s.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)n="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);n=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else n=t.propertyType==s.nodeId?e.toString():null==this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]?void 0:this._manager._propertyHash[e][t.propertyName];null==n&&(n="");let o=0,a=0,h=0,l=0,d=0;for(let e=0;e<r.length;e++){let i,p;if('"'==r[e][0]||'"'==r[e][1])if(i=!0,'"'==r[e][0])p=r[e].substring(1,r[e].length-1);else{let t=r[e][0];p=r[e].substring(2,r[e].length-1),p=t+p}else p=r[e],i=!1;if(t.propertyType==s.nodeId&&(i=!0),""==p||1==p.length&&("+"==p[0]||"-"==p[0]))return;"+"==p[0]?(a++,i?n.toLowerCase()==p.substring(1).toLowerCase()&&o++:-1!=n.toLowerCase().indexOf(p.substring(1).toLowerCase())&&o++):"-"==p[0]?(h++,i?n.toLowerCase()!=p.substring(1).toLowerCase()&&l++:-1==n.toLowerCase().indexOf(p.substring(1).toLowerCase())&&l++):i?n.toLowerCase()==p.toLowerCase()&&d++:-1!=n.toLowerCase().indexOf(p.toLowerCase())&&d++}return a==o&&h==l&&(d>0||o+l==r.length)}}async _testNodeAgainstConditions(e,t,i){let n=0,o=!1;t.length>1&&!t[1].and&&(o=!0);for(let a=0;a<t.length;a++){let h;if(t[a].propertyType==s.relationship)"Rel:SpaceBoundary"==t[a].propertyName?h=await this._checkSpaceBoundaryCondition(e,t[a]):"Rel:ContainedIn"==t[a].propertyName&&(h=await this._checkContainedInCondition(e,t[a]));else if(t[a].propertyType==s.SQuery){if(!t[a].SQuery)if(t[a].SQueryID)t[a].SQuery=this._manager.getSQueryByID(t[a].SQueryID);else{let e=this._manager.getSQueryByName(t[a].text);t[a].SQueryID=e.filter._id,t[a].SQuery=e.filter}h=await this._testNodeAgainstConditions(e,t[a].SQuery._conditions,i),t[a].conditionType==r.unequal&&(h=!h)}else h=t[a].childFilter?await this._testNodeAgainstConditions(e,t[a].childFilter._conditions,i):await this._checkCondition(e,t[a],i);if(0==h){if(!o)break}else n++}return!!(!o&&n==t.length||o&&n>0)}async _gatherMatchingNodesRecursive(e,t,i,r,s){let n=this._viewer.model.getNodeName(t);if(t!=r&&await this._testNodeAgainstConditions(t,e,s)&&(i.push(t),!this._keepSearchingChildren))return;let o=this._viewer.model.getNodeChildren(t);for(let t=0;t<o.length;t++)await this._gatherMatchingNodesRecursive(e,o[t],i,r,s+n)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}class a{constructor(e){this._viewer=e,this._SQuerys=[],this._modelHash=[]}addSQuery(e,t){this._SQuerys.push({filter:e,isProp:t})}getSQuerys(){return this._SQuerys}getSQueryByName(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t].filter.getName()==e)return this._SQuerys[t]}getSQueryByID(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t].filter._id==e)return this._SQuerys[t].filter}getSQueryNum(){return this._SQuerys.length}getSQuery(e){return this._SQuerys[e].filter}getSQueryID(e){return this._SQuerys[e].filter._id}getIsProp(e){return this._SQuerys[e].isProp}removeSQuery(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t].filter._id==e)return this._SQuerys.splice(t,1)}updateSQuery(e,t){this._SQuerys[e].filter=t}updateSQueryIsProp(e,t){for(let i=0;i<this._SQuerys.length;i++)this._SQuerys[i].filter._id==e&&(this._SQuerys[i].isProp=t)}toJSON(){let e=[];for(let t=0;t<this._SQuerys.length;t++)e.push({filter:this._SQuerys[t].filter.toJSON(),isProp:this._SQuerys[t].isProp});return e}fromJSON(e){this._SQuerys=[];for(let t=0;t<e.length;t++){let i=new o(this);i.fromJSON(e[t].filter),this.addSQuery(i,e[t].isProp)}return e}async evaluateProperties(e){let t=[];for(let i=0;i<this._SQuerys.length;i++)if(this._SQuerys[i].isProp){let r=this._SQuerys[i].filter,s=!1;if(!r._keepSearchingChildren){let t=e;for(;t=this._viewer.model.getNodeParent(t),t!=this._viewer.model.getRootNode();)if(await r.testOneNodeAgainstConditions(t)){s=!0;break}}if(s)continue;if(await r.testOneNodeAgainstConditions(e)){let i=await r.findAllPropertiesOnNode(e),s=r.getName();""==s&&(s=r.generateString()),t.push({name:s,properties:i})}}return t}_getModelTreeIdsRecursive(e,t,i){t.push(this._viewer.model.getNodeProperties(e)),i.push(e);let r=this._viewer.model.getNodeChildren(e);for(let e=0;e<r.length;e++)this._getModelTreeIdsRecursive(r[e],t,i)}addModel(e,t,i){for(let i=0;i<this._modelHash.length;i++)if(this._modelHash[i].id==e)return void(this._modelHash[i].nodeid=t);this._modelHash.push({id:e,nodeid:t,savedHash:i,ids:null,properties:null})}_updateHashes(e,t,i){for(let r=0;r<t.length;r++){this._propertyHash[e[r]]=t[r];let s=this._viewer.model.getNodeLayerId(e[r]);if(null!=s&&i.size>1)if(null==this._propertyHash[e[r]]&&(this._propertyHash[e[r]]=[]),3==this._viewer.model.getNodeType(e[r])){let t=this._viewer.model.getNodeParent(e[r]);null==this._propertyHash[t]&&(this._propertyHash[t]=[]),this._propertyHash[t].LAYER=i.get(s)}else this._propertyHash[e[r]].LAYER=i.get(s);for(let e in t[r])this._allPropertiesHash[e]=[]}for(let e in this._propertyHash)for(let t in this._propertyHash[e])this._allPropertiesHash[t][this._propertyHash[e][t]]=!0}parseSavedPropertyHash(e){let t=e.allprops,i=e.nodeprops,r=e.related,s=[],n=[];for(let e=0;e<i.length;e++){let r=i[e];n.push(r.i);let o={},a=r.p;for(let e=0;e<a.length;e+=2)o[t[a[e]].name]=t[a[e]].values[a[e+1]];s.push(o)}let o=[],a=[];if(r)for(let e=0;e<r.length;e++){let t=r[e];t.e?o[parseInt(t.i)]=t.e:o[parseInt(t.i)]=[],t.f?a[parseInt(t.i)]=t.f:a[parseInt(t.i)]=[]}return{ids:n,props:s,relatedSpaceBoundary:o,relatedContainedIn:a}}gatherRelatedDataHashesRecursive(e,t){let i=this._viewer.model.getBimIdFromNode(e),r=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.SpaceBoundary),s={i:e},n=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.ContainedInSpatialStructure);r&&r.length>0&&(s.e=r),n&&n.length>0&&(s.f=n),t.push(s);let o=this._viewer.model.getNodeChildren(e);for(let e=0;e<o.length;e++)this.gatherRelatedDataHashesRecursive(o[e],t)}exportPropertyHash(){let e=[],t=[],i=[];for(let t in this._allPropertiesHash){let r={name:t,values:Object.keys(this._allPropertiesHash[t])},s=[];for(let e=0;e<r.values.length;e++)s[r.values[e]]=e;r.ehash=s,e.push(r),i[t]=e.length-1}for(let r in this._propertyHash){let s=[];for(let t in this._propertyHash[r]){let n=e[i[t]];s.push(i[t],n.ehash[this._propertyHash[r][t]])}t.push({i:r,p:s})}for(let t=0;t<e.length;t++)e[t].ehash=void 0;return this.gatherRelatedDataHashesRecursive(this._viewer,this._viewer.model.getRootNode(),[]),{allprops:e,nodeprops:t}}_consolidateBodies(){let e=[];for(let t in this._propertyHash)3==this._viewer.model.getNodeType(parseInt(t))&&this._propertyHash[t].Volume&&(e[this._viewer.model.getNodeParent(parseInt(t))]=!0);for(let t in e){let e=this._viewer.model.getNodeChildren(parseInt(t)),i=0,r=0;for(let t=0;t<e.length;t++){let s=e[t];this._propertyHash[s]&&this._propertyHash[s].Volume&&(i+=parseFloat(this._propertyHash[s].Volume)),this._propertyHash[s]&&this._propertyHash[s]["Surface Area"]&&(r+=parseFloat(this._propertyHash[s]["Surface Area"]))}if(i+="mm³",r+="mm²",this._propertyHash[t].Volume=i,this._propertyHash[t]["Surface Area"]=r,this._viewer.model.getNodeName(parseInt(t)).startsWith("Product")){let e=this._viewer.model.getNodeParent(parseInt(t));this._propertyHash[e].Volume=i,this._propertyHash[e]["Surface Area"]=r}}}async initialize(){this._propertyHash=[],this._allPropertiesHash=[],this._containedInSpatialStructureHash=[],this._spaceBoundaryHash=[];let e=this._viewer.model.getLayers();if(0==this._modelHash.length){let t=[],i=[];this._getModelTreeIdsRecursive(this._viewer.model.getRootNode(),t,i);let r=await Promise.all(t);this._updateHashes(i,r,e),this._consolidateBodies()}else for(let t=0;t<this._modelHash.length;t++){let i=this._modelHash[t],r=[],s=null,n=this._viewer.model.getNodeIdOffset(i.nodeid);if(i.ids){for(let e=0;e<i.ids.length;e++)r.push(i.ids[e]+n);s=i.properties}else{let e=[];if(i.savedHash){let e=this.parseSavedPropertyHash(i.savedHash);s=e.props,r=e.ids,this._containedInSpatialStructureHash=e.relatedContainedIn,this._spaceBoundaryHash=e.relatedSpaceBoundary}else this._getModelTreeIdsRecursive(i.nodeid,e,r),s=await Promise.all(e);i.properties=s,i.ids=[];for(let e=0;e<r.length;e++)i.ids.push(r[e]-n)}this._updateHashes(r,s,e)}}getAllProperties(){let e=[],t=!1;this._allPropertiesHash.TYPE&&(t=!0);let i=!1;this._allPropertiesHash.LAYER&&(i=!0);let r=!1;this._allPropertiesHash["Surface Area"]&&(r=!0);let s=!1;this._allPropertiesHash.Volume&&(s=!0);for(let t in this._allPropertiesHash)"TYPE"!=t&&"LAYER"!=t&&"Surface Area"!=t&&"Volume"!=t&&e.push(t);return e.sort(),e.unshift("---"),e.unshift("SQuery"),i&&e.unshift("LAYER"),t&&e.unshift("TYPE"),r&&e.unshift("Surface Area"),s&&e.unshift("Volume"),e.unshift("Rel:SpaceBoundary"),e.unshift("Rel:ContainedIn"),e.unshift("Node Color"),e.unshift("Node Type"),e.unshift("Node Chain"),e.unshift("Node Parent"),e.unshift("Nodeid"),e.unshift("Node Name"),e}}function h(){return"1.0.3"}hcSQuery=t})();