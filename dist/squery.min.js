var hcSQuery;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SQuery:()=>o,SQueryCondition:()=>n,SQueryConditionType:()=>i,SQueryManager:()=>a,SQueryPropertyType:()=>r,SQueryRelationshipType:()=>s,getVersion:()=>h});const i={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6,greaterOrEqualDate:7,lessOrEqualDate:8},r={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,SQuery:7,numChildren:8,ifcglobalid:9},s={none:0,nodeParent:1,nodeChildren:2,containedIn:3,spaceBoundary:4,aggregate:5};class n{static convertEnumConditionToString(e){switch(e){case i.contains:return"contains";case i.exists:return"exists";case i.notExists:return"!exists";case i.greaterOrEqual:return">=";case i.lessOrEqual:return"<=";case i.greaterOrEqualDate:return">=(Date)";case i.lessOrEqualDate:return"<=(Date)";case i.equals:return"=";case i.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return i.contains;case"exists":return i.exists;case"!exists":return i.notExists;case">=":return i.greaterOrEqual;case"<=":return i.lessOrEqual;case"=":return i.equals;case"≠":return i.unequal;case">=(Date)":return i.greaterOrEqualDate;case"<=(Date)":return i.lessOrEqualDate}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SQuery")>-1)return r.SQuery;switch(e){case"Node Name":return r.nodeName;case"Nodeid":return r.nodeId;case"Node Chain":return r.nodeChain;case"Node Type":return r.nodeType;case"Node Color":return r.nodeColor;case"Rel:IFC ContainedIn":case"Rel:IFC SpaceBoundary":case"Rel:IFC Aggregate":case"Rel:Node Parent":case"Rel:Node Children":case"Rel:Node Children":return r.relationship;case"SQuery":return r.SQuery;case"# Children":return r.numChildren;case"IFC GlobalId":return r.ifcglobalid;default:return r.property}}static convertStringToRelationshipType(e){switch(e){case"Rel:IFC ContainedIn":return s.containedIn;case"Rel:IFC SpaceBoundary":return s.spaceBoundary;case"Rel:IFC Aggregate":return s.aggregate;case"Rel:Node Parent":return s.nodeParent;case"Rel:Node Children":return s.nodeChildren;default:return!1}}static convertEnumRelationshipTypeToString(e){switch(e){case s.containedIn:return"IFC ContainedIn";case s.spaceBoundary:return"IFC SpaceBoundary";case s.aggregate:return"IFC Aggregate";case s.nodeParent:return"Node Parent";case s.nodeChildren:return"Node Children"}}constructor(){this.and=!0,this.conditionType=i.contains,this.propertyType=r.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.SQueryID=null,this.relationship=!1}toJSON(e){if(this.propertyType==r.SQuery&&!this.squeryFitlerID){let t=e.getSQueryByName(this.text);t&&(this.SQueryID=t._id)}return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,SQueryID:this.SQueryID,relationship:this.relationship}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.SQueryID=e.SQueryID,this.relationship=null!=e.relationship&&e.relationship}setSQueryID(e){this.squeryFitlerID=e}getSQueryID(){return this.SQueryID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}class o{constructor(e,t){this._manager=e,this._viewer=this._manager._viewer,this._limitselectionlist=[],this._conditions=[],this._name="",this._action="",this._keepSearchingChildren=!1,this._prop=!1,this._id=this._generateGUID(),this._searchCounter=0,this._startnode=t||this._viewer.model.getRootNode()}getAction(){return this._action}setAction(e){this._action=e}async performAction(e,t=!0){if(""==this._action)return;let i;i=e||await this.apply();let r=[];if(t||"Isolate"==this._action)r=i;else for(let e=0;e<i.length;e++)this._viewer.model.getBranchVisibility(i[e])&&r.push(i[e]);switch(this._action){case"red":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(255,0,0));break;case"green":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(0,255,0));break;case"blue":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(0,0,255));break;case"yellow":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(255,255,0));break;case"grey":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(128,128,128));break;case"Transparent":await this._viewer.model.setNodesOpacity(r,.7);break;case"Isolate":await this._viewer.view.isolateNodes(r,0,!1);break;case"Show":await this._viewer.model.setNodesVisibility(r,!0);break;case"Hide":await this._viewer.model.setNodesVisibility(r,!1);break;case"Select":let e=[];for(let t=0;t<r.length;t++)e.push(new Communicator.Selection.SelectionItem(r[t]));await this._viewer.selectionManager.add(e)}}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}updateConditions(e){this._conditions=e}setProp(e){this._prop=e}getProp(){return this._prop}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){if(1==this._conditions.length&&this._conditions[0].childFilter){let e=this._conditions[0].childFilter;this._conditions.splice(0,1);for(let t=0;t<e._conditions.length;t++)this._conditions.unshift(e._conditions[t])}else this._conditions.splice(e,1)}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let i=new n;i.fromJSON(e.conditions[t]),this._conditions.push(i)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new o(this._manager,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name,null==e.prop?this._prop=!1:this._prop=e.prop,null==e.action?this._action="":this._action=e.action,null==e.keepSearchingChildren?this._keepSearchingChildren=!1:this._keepSearchingChildren=e.keepSearchingChildren,e.id&&(this._id=e.id)}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let i=this._conditions[t].toJSON(this._manager);this._conditions[t].childFilter&&(i.childFilter=this._conditions[t].childFilter.toJSON()),e.push(i)}return{action:this._action,conditions:e,name:this._name,id:this._id,keepSearchingChildren:this._keepSearchingChildren,prop:this._prop}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getLimitSelectionList(){return this._limitselectionlist}getStartNode(){return this._startnode}async apply(){this._searchCounter=0;let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let i=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._startnode,""):await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._viewer.model.getNodeParent(this._startnode),"");else for(let r=0;r<t.length;r++)await this._gatherMatchingNodesRecursive(e,t[r],i,this._viewer.model.getNodeParent(t[r]),"");return i}createChainText(e,t,i){let r=e,s=[];for(;;){let e=this._viewer.model.getNodeParent(r);if(null==e||e==t)break;s.push(this._viewer.model.getNodeName(e)),r=e}let n="";for(let e=s.length-1-i;e>=0;e--)n+=e>0?s[e]+"->":s[e];return n}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions,"")}async findAllPropertiesOnNode(e,t,i,s){let n,o,a;t?(n=t,o=i,a=s):(n=this._conditions,o=[],a=[]);for(let t=0;t<n.length;t++)if(n[t].childFilter)await this.findAllPropertiesOnNode(e,n[t].childFilter._conditions,o,a);else if(n[t].propertyType==r.property){let i=this._manager._propertyHash[e];i[n[t].propertyName]&&!a[n[t].propertyName]&&(a[n[t].propertyName]=!0,o.push({name:n[t].propertyName,value:i[n[t].propertyName]}))}return o}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":(this._conditions[t].relationship&&(e+="Rel:"+n.convertEnumRelationshipTypeToString(this._conditions[t].relationship)+"("),this._conditions[t].propertyType==r.SQuery&&(e+="("),e+=this._conditions[t].propertyName+" "+n.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text,this._conditions[t].propertyType==r.SQuery&&(e+=")"),this._conditions[t].relationship&&(e+=")"));return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryCondition(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(this._manager._spaceBoundaryHash[e]?i=this._manager._spaceBoundaryHash[e]:(i=this._viewer.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.SpaceBoundary),this._manager._spaceBoundaryHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e),s=[];s.push(t);let n=t.relationship;t.relationship=!1;for(let e=0;e<i.length;e++)if(await this._testNodeAgainstConditions(parseInt(i[e])+r,s,""))return t.relationship=n,!0;t.relationship=n}return!1}async _checkNodeParentCondition(e,t){let i=this._viewer.model.getNodeParent(e),r=this._viewer.model.getNodeIdOffset(e),s=[];s.push(t);let n=t.relationship;return t.relationship=!1,await this._testNodeAgainstConditions(i+r,s,"")?(t.relationship=n,!0):(t.relationship=n,!1)}async _checkNodeChildrenCondition(e,t){let i=this._viewer.model.getNodeChildren(e);if(i.length>0){let r=this._viewer.model.getNodeIdOffset(e),s=[];s.push(t);let n=t.relationship;t.relationship=!1;for(let e=0;e<i.length;e++)if(await this._testNodeAgainstConditions(i[e]+r,s,""))return t.relationship=n,!0;t.relationship=n}return!1}async _checkAggregateCondition(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(this._manager._aggregateHash[e]?i=this._manager._aggregateHash[e]:(i=this._viewer.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.Aggregates),this._manager._aggregateHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e),s=[];s.push(t);let n=t.relationship;t.relationship=!1;for(let e=0;e<i.length;e++)if(await this._testNodeAgainstConditions(parseInt(i[e])+r,s,""))return t.relationship=n,!0;t.relationship=n}return!1}async _checkContainedInCondition(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(this._manager._containedInSpatialStructureHash[e]?i=this._manager._containedInSpatialStructureHash[e]:(i=this._viewer.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.ContainedInSpatialStructure),this._manager._containedInSpatialStructureHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e),s=[];s.push(t);let n=t.relationship;t.relationship=!1;for(let e=0;e<i.length;e++)if(await this._testNodeAgainstConditions(parseInt(i[e])+r,s,""))return t.relationship=n,!0;t.relationship=n}return!1}async _checkCondition(e,t,s){if(t.conditionType!=i.contains){if(t.conditionType==i.exists)return!(!this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]);if(t.conditionType==i.notExists)return!(!this._manager._propertyHash[e]||null!=this._manager._propertyHash[e][t.propertyName]);let s;if(t.propertyType==r.nodeName)s=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==r.nodeId)s=e;else if(t.propertyType==r.numChildren)s=this._viewer.model.getNodeChildren(e).length;else{let r;if(this._manager._propertyHash[e]&&(r=this._manager._propertyHash[e][t.propertyName]),null==r)return t.conditionType==i.unequal;s=parseFloat(r)}if(t.conditionType==i.greaterOrEqualDate||t.conditionType==i.lessOrEqualDate){let r;if(this._manager._propertyHash[e]&&(r=this._manager._propertyHash[e][t.propertyName]),null==r)return!1;-1!=r.indexOf(" ")||isNaN(parseInt(r))||(r=parseInt(r));let s=new Date(r);if(isNaN(s.getDate()))return!1;let n=t.text;-1!=n.indexOf(" ")||isNaN(parseInt(n))||(n=parseInt(n));let o=new Date(n);if(t.conditionType==i.greaterOrEqualDate){if(s>=o)return!0}else if(t.conditionType==i.lessOrEqualDate&&s<=o)return!0;return!1}{let e=parseFloat(t.text);if(isNaN(e)||isNaN(s))return!1;if(t.conditionType==i.greaterOrEqual){if(s>=e)return!0}else if(t.conditionType==i.lessOrEqual){if(s<=e)return!0}else if(t.conditionType==i.unequal){if(s!=e)return!0}else if(s==e)return!0;return!1}}{let i=t.text.split(","),n="";if(t.propertyType==r.nodeName)n=this._viewer.model.getNodeName(e);else if(t.propertyType==r.relationship)n=s;else if(t.propertyType==r.nodeChain)n=s||this.createChainText(e,this._viewer.model.getRootNode(),0);else if(t.propertyType==r.numChildren){let t=this._viewer.model.getNodeChildren(e);for(let e=0;e<t.length;e++)n+=this._viewer.model.getNodeName(t[e])}else if(t.propertyType==r.nodeType)n=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==r.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)n="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);n=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else n=t.propertyType==r.nodeId?e.toString():t.propertyType==r.ifcglobalid?hwv.model.getGenericIdFromBimId(e,e.toString()):null==this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]?void 0:this._manager._propertyHash[e][t.propertyName];null==n&&(n="");let o=0,a=0,h=0,l=0,d=0;for(let e=0;e<i.length;e++){let s,p;if('"'==i[e][0]||'"'==i[e][1])if(s=!0,'"'==i[e][0])p=i[e].substring(1,i[e].length-1);else{let t=i[e][0];p=i[e].substring(2,i[e].length-1),p=t+p}else p=i[e],s=!1;if(t.propertyType==r.nodeId&&(s=!0),""==p||1==p.length&&("+"==p[0]||"-"==p[0]))return;"+"==p[0]?(a++,s?n.toLowerCase()==p.substring(1).toLowerCase()&&o++:-1!=n.toLowerCase().indexOf(p.substring(1).toLowerCase())&&o++):"-"==p[0]?(h++,s?n.toLowerCase()!=p.substring(1).toLowerCase()&&l++:-1==n.toLowerCase().indexOf(p.substring(1).toLowerCase())&&l++):s?n.toLowerCase()==p.toLowerCase()&&d++:-1!=n.toLowerCase().indexOf(p.toLowerCase())&&d++}return a==o&&h==l&&(d>0||o+l==i.length)}}async _testNodeAgainstConditions(e,t,n){let o=0,a=!1;t.length>1&&!t[1].and&&(a=!0);for(let h=0;h<t.length;h++){let l;if(t[h].relationship)t[h].relationship==s.spaceBoundary?l=await this._checkSpaceBoundaryCondition(e,t[h]):t[h].relationship==s.containedIn?l=await this._checkContainedInCondition(e,t[h]):t[h].relationship==s.aggregate?l=await this._checkAggregateCondition(e,t[h]):t[h].relationship==s.nodeParent?l=await this._checkNodeParentCondition(e,t[h]):t[h].relationship==s.nodeChildren&&(l=await this._checkNodeChildrenCondition(e,t[h]));else if(t[h].propertyType==r.SQuery){if(!t[h].SQuery)if(t[h].SQueryID)t[h].SQuery=this._manager.getSQueryByID(t[h].SQueryID);else{let e=this._manager.getSQueryByName(t[h].text);t[h].SQueryID=e._id,t[h].SQuery=e}l=await this._testNodeAgainstConditions(e,t[h].SQuery._conditions,n),t[h].conditionType==i.unequal&&(l=!l)}else l=t[h].childFilter?await this._testNodeAgainstConditions(e,t[h].childFilter._conditions,n):await this._checkCondition(e,t[h],n);if(0==l){if(!a)break}else o++}return!!(!a&&o==t.length||a&&o>0)}async _gatherMatchingNodesRecursive(e,t,i,r,s){if(this._searchCounter++,this._searchCounter%1500==0&&await new Promise((e=>setTimeout(e,1))),this._manager.getSearchVisible()&&!this._viewer.model.getBranchVisibility(t))return;let n=this._viewer.model.getNodeName(t);if(t!=r&&await this._testNodeAgainstConditions(t,e,s)&&(i.push(t),null!=this._manager.getKeepSearchingChildren()?!this._manager.getKeepSearchingChildren():!this._keepSearchingChildren))return;let o=this._viewer.model.getNodeChildren(t);for(let t=0;t<o.length;t++)await this._gatherMatchingNodesRecursive(e,o[t],i,r,s+n)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}class a{constructor(e){this._viewer=e,this._SQuerys=[],this._modelHash=[],this._keepSearchingChildren=!1,this._searchVisible=!1}setSearchVisible(e){this._searchVisible=e}getSearchVisible(){return this._searchVisible}addSQuery(e){this._SQuerys.push(e)}async executeSQueries(){await this._viewer.model.reset(),await this._viewer.model.unsetNodesFaceColor([this._viewer.model.getAbsoluteRootNode()]),await this._viewer.selectionManager.clear();for(let e=0;e<this._SQuerys.length;e++)await this._SQuerys[e].performAction(null,!1)}setSQueries(e){this._SQuerys=e}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}getSQuerys(){return this._SQuerys}getSQueryByName(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t].getName()==e)return this._SQuerys[t]}getSQueryByID(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t]._id==e)return this._SQuerys[t]}getSQueryNum(){return this._SQuerys.length}getSQuery(e){return this._SQuerys[e]}getSQueryID(e){return this._SQuerys[e]._id}removeSQuery(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t]._id==e)return this._SQuerys.splice(t,1)}updateSQuery(e,t){this._SQuerys[e]=t}updateSQueryIsProp(e,t){for(let i=0;i<this._SQuerys.length;i++)this._SQuerys[i]._id==e&&this._SQuerys[i].setProp(t)}toJSON(){let e=[];for(let t=0;t<this._SQuerys.length;t++)e.push(this._SQuerys[t].toJSON());return e}fromJSON(e){this._SQuerys=[];for(let t=0;t<e.length;t++){let i=new o(this);i.fromJSON(e[t]),this.addSQuery(i)}return e}async evaluateProperties(e){let t=[];for(let i=0;i<this._SQuerys.length;i++)if(this._SQuerys[i].getProp()){let r=this._SQuerys[i],s=!1;if(null!=this._keepSearchingChildren?!this._keepSearchingChildren:!r._keepSearchingChildren){let t=e;for(;t=this._viewer.model.getNodeParent(t),t!=this._viewer.model.getRootNode();)if(await r.testOneNodeAgainstConditions(t)){s=!0;break}}if(s)continue;if(await r.testOneNodeAgainstConditions(e)){let i=await r.findAllPropertiesOnNode(e),s=r.getName();""==s&&(s=r.generateString()),t.push({name:s,properties:i})}}return t}_getModelTreeIdsRecursive(e,t,i){t.push(this._viewer.model.getNodeProperties(e)),i.push(e);let r=this._viewer.model.getNodeChildren(e);for(let e=0;e<r.length;e++)this._getModelTreeIdsRecursive(r[e],t,i)}addModel(e,t,i){for(let i=0;i<this._modelHash.length;i++)if(this._modelHash[i].id==e)return void(this._modelHash[i].nodeid=t);this._modelHash.push({id:e,nodeid:t,savedHash:i,ids:null,properties:null})}_updateHashes(e,t,i){for(let r=0;r<t.length;r++){this._propertyHash[e[r]]=t[r];let s=this._viewer.model.getNodeLayerId(e[r]);if(null!=s&&i.size>1)if(null==this._propertyHash[e[r]]&&(this._propertyHash[e[r]]=[]),3==this._viewer.model.getNodeType(e[r])){let t=this._viewer.model.getNodeParent(e[r]);null==this._propertyHash[t]&&(this._propertyHash[t]=[]),this._propertyHash[t].LAYER=i.get(s)}else this._propertyHash[e[r]].LAYER=i.get(s);for(let e in t[r])this._allPropertiesHash[e]=[],null==this._allPropertiesHashNum[e]?this._allPropertiesHashNum[e]=1:this._allPropertiesHashNum[e]++}for(let e in this._propertyHash)for(let t in this._propertyHash[e])this._propertyHash[e][t]=this._propertyHash[e][t].replace(/,/g,"."),this._allPropertiesHash[t][this._propertyHash[e][t]]=!0}parseSavedPropertyHash(e){let t=e.allprops,i=e.nodeprops,r=e.related,s=[],n=[];for(let e=0;e<i.length;e++){let r=i[e];n.push(r.i);let o={},a=r.p;for(let e=0;e<a.length;e+=2)o[t[a[e]].name]=t[a[e]].values[a[e+1]];s.push(o)}let o=[],a=[],h=[];if(r)for(let e=0;e<r.length;e++){let t=r[e];t.e?o[parseInt(t.i)]=t.e:o[parseInt(t.i)]=[],t.f?a[parseInt(t.i)]=t.f:a[parseInt(t.i)]=[],t.g?h[parseInt(t.i)]=t.g:h[parseInt(t.i)]=[]}return{ids:n,props:s,relatedSpaceBoundary:o,relatedContainedIn:a,relatedAggregateIn:h}}gatherRelatedDataHashesRecursive(e,t){let i=this._viewer.model.getBimIdFromNode(e),r={i:e},s=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.SpaceBoundary),n=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.ContainedInSpatialStructure),o=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.Aggregates);s&&s.length>0&&(r.e=s),n&&n.length>0&&(r.f=n),o&&o.length>0&&(r.g=o),t.push(r);let a=this._viewer.model.getNodeChildren(e);for(let e=0;e<a.length;e++)this.gatherRelatedDataHashesRecursive(a[e],t)}exportPropertyHash(){let e=[],t=[],i=[];for(let t in this._allPropertiesHash){let r={name:t,values:Object.keys(this._allPropertiesHash[t])},s=[];for(let e=0;e<r.values.length;e++)s[r.values[e]]=e;r.ehash=s,e.push(r),i[t]=e.length-1}for(let r in this._propertyHash){let s=[];for(let t in this._propertyHash[r]){let n=e[i[t]];s.push(i[t],n.ehash[this._propertyHash[r][t]])}t.push({i:r,p:s})}for(let t=0;t<e.length;t++)e[t].ehash=void 0;return this.gatherRelatedDataHashesRecursive(this._viewer,this._viewer.model.getRootNode(),[]),{allprops:e,nodeprops:t}}_consolidateBodies(){let e=[];for(let t in this._propertyHash)3==this._viewer.model.getNodeType(parseInt(t))&&this._propertyHash[t].Volume&&(e[this._viewer.model.getNodeParent(parseInt(t))]=!0);for(let t in e){let e=this._viewer.model.getNodeChildren(parseInt(t)),i=0,r=0;for(let t=0;t<e.length;t++){let s=e[t];this._propertyHash[s]&&this._propertyHash[s].Volume&&(i+=parseFloat(this._propertyHash[s].Volume)),this._propertyHash[s]&&this._propertyHash[s]["Surface Area"]&&(r+=parseFloat(this._propertyHash[s]["Surface Area"]))}if(i+="mm³",r+="mm²",this._propertyHash[t].Volume=i,this._propertyHash[t]["Surface Area"]=r,this._viewer.model.getNodeName(parseInt(t)).startsWith("Product")){let e=this._viewer.model.getNodeParent(parseInt(t));this._propertyHash[e].Volume=i,this._propertyHash[e]["Surface Area"]=r}}}async initialize(){this._propertyHash=[],this._allPropertiesHash=[],this._allPropertiesHashNum=[],this._containedInSpatialStructureHash=[],this._aggregateHash=[],this._spaceBoundaryHash=[];let e=this._viewer.model.getLayers();if(0==this._modelHash.length){let t=[],i=[];this._getModelTreeIdsRecursive(this._viewer.model.getRootNode(),t,i);let r=await Promise.all(t);this._updateHashes(i,r,e),this._consolidateBodies()}else for(let t=0;t<this._modelHash.length;t++){let i=this._modelHash[t],r=[],s=null,n=this._viewer.model.getNodeIdOffset(i.nodeid);if(i.ids){for(let e=0;e<i.ids.length;e++)r.push(i.ids[e]+n);s=i.properties}else{let e=[];if(i.savedHash){let e=this.parseSavedPropertyHash(i.savedHash);s=e.props,r=e.ids,this._containedInSpatialStructureHash=e.relatedContainedIn,this._aggregateHash=e.relatedAggregateIn,this._spaceBoundaryHash=e.relatedSpaceBoundary}else this._getModelTreeIdsRecursive(i.nodeid,e,r),s=await Promise.all(e);i.properties=s,i.ids=[];for(let e=0;e<r.length;e++)i.ids.push(r[e]-n)}this._updateHashes(r,s,e)}}getAllOptionsForProperty(e){return this._allPropertiesHash[e]}getNumOptions(e){if(null!=this._allPropertiesHash[e])return Object.keys(this._allPropertiesHash[e]).length}getNumOptionsUsed(e){if(null!=this._allPropertiesHash[e])return this._allPropertiesHashNum[e]}getAllProperties(e=!1){let t=[],i=!1;this._allPropertiesHash.TYPE&&(i=!0);let r=!1;this._allPropertiesHash.LAYER&&(r=!0);let s=!1;this._allPropertiesHash["Surface Area"]&&(s=!0);let n=!1;this._allPropertiesHash.Volume&&(n=!0);for(let e in this._allPropertiesHash)"TYPE"!=e&&"LAYER"!=e&&"Surface Area"!=e&&"Volume"!=e&&t.push(e);return t.sort(),i&&t.unshift("TYPE"),t.unshift("---"),e||(t.unshift("IFC GlobalId"),t.unshift("Rel:IFC SpaceBoundary"),t.unshift("Rel:IFC Aggregate"),t.unshift("Rel:IFC ContainedIn"),t.unshift("---")),t.unshift("Rel:Node Children"),t.unshift("Rel:Node Parent"),t.unshift("SQuery"),t.unshift("# Children"),r&&t.unshift("LAYER"),s&&t.unshift("Surface Area"),n&&t.unshift("Volume"),t.unshift("Node Color"),t.unshift("Node Type"),t.unshift("Node Chain"),t.unshift("Nodeid"),t.unshift("Node Name"),t}}function h(){return"1.0.3"}hcSQuery=t})();