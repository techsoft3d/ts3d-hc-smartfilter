var hcSQuery;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SQuery:()=>n,SQueryCondition:()=>a,SQueryConditionType:()=>i,SQueryEditorUI:()=>u,SQueryManager:()=>l,SQueryManagerUI:()=>c,SQueryPropertiesUI:()=>p,SQueryPropertyType:()=>r,SQueryRelationshipType:()=>o,SQueryResult:()=>s,SQueryResultsUI:()=>d,getVersion:()=>h});const i={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6,greaterOrEqualDate:7,lessOrEqualDate:8,evaluate:9},r={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,SQuery:7,numChildren:8,ifcglobalid:9,bounding:10},o={none:0,nodeParent:1,nodeChildren:2,containedIn:3,spaceBoundary:4,aggregate:5};class a{static convertEnumConditionToString(e){switch(e){case i.contains:return"contains";case i.exists:return"exists";case i.notExists:return"!exists";case i.greaterOrEqual:return">=";case i.lessOrEqual:return"<=";case i.greaterOrEqualDate:return">=(Date)";case i.lessOrEqualDate:return"<=(Date)";case i.equals:return"=";case i.evaluate:return"evaluate";case i.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return i.contains;case"exists":return i.exists;case"!exists":return i.notExists;case">=":return i.greaterOrEqual;case"<=":return i.lessOrEqual;case"=":return i.equals;case"≠":return i.unequal;case">=(Date)":return i.greaterOrEqualDate;case"<=(Date)":return i.lessOrEqualDate;case"evaluate":return i.evaluate}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SQuery")>-1)return r.SQuery;switch(e){case"Node Name":return r.nodeName;case"Nodeid":return r.nodeId;case"Node Chain":return r.nodeChain;case"Node Type":return r.nodeType;case"Node Color":return r.nodeColor;case"Rel:IFC ContainedIn":case"Rel:IFC SpaceBoundary":case"Rel:IFC Aggregate":case"Rel:Node Parent":case"Rel:Node Children":case"Rel:Node Children":return r.relationship;case"SQuery":return r.SQuery;case"# Children":return r.numChildren;case"IFC GlobalId":return r.ifcglobalid;case"Bounding":return r.bounding;default:return r.property}}static convertStringToRelationshipType(e){switch(e){case"Rel:IFC ContainedIn":return o.containedIn;case"Rel:IFC SpaceBoundary":return o.spaceBoundary;case"Rel:IFC Aggregate":return o.aggregate;case"Rel:Node Parent":return o.nodeParent;case"Rel:Node Children":return o.nodeChildren;default:return!1}}static convertEnumRelationshipTypeToString(e){switch(e){case o.containedIn:return"IFC ContainedIn";case o.spaceBoundary:return"IFC SpaceBoundary";case o.aggregate:return"IFC Aggregate";case o.nodeParent:return"Node Parent";case o.nodeChildren:return"Node Children"}}constructor(){this.and=!0,this.conditionType=i.contains,this.propertyType=r.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.SQueryID=null,this.relationship=!1}toJSON(e){if(this.propertyType==r.SQuery&&!this.squeryFitlerID){let t=e.getSQueryByName(this.text);t&&(this.SQueryID=t._id)}return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,SQueryID:this.SQueryID,relationship:this.relationship}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.SQueryID=e.SQueryID,this.relationship=null!=e.relationship&&e.relationship}setSQueryID(e){this.squeryFitlerID=e}getSQueryID(){return this.SQueryID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}class s{static createChainText(e,t,i,r){let o=t,a=[];for(;;){let t=e.model.getNodeParent(o);if(null==t||t==i)break;a.push(e.model.getNodeName(t)),o=t}let s="";for(let e=a.length-1-r;e>=0;e--)s+=e>0?a[e]+"->":a[e];return s}constructor(e,t){this._manager=e,this._viewer=this._manager._viewer,this._query=t}getTableProperty(){return this._tableProperty}setTableProperty(e){this._tableProperty=e}getCategoryHash(){return this._categoryHash}generateItems(e,t,i){this._items=[];for(let r=0;r<e.length;r++){let o=s.createChainText(this._viewer,e[r],t,i),a={name:this._viewer.model.getNodeName(e[r]),id:e[r],chaintext:o};this._items.push(a)}}getItems(){return this._items}makeVisible(e){let t=this._itemsToSelections();this._viewer.model.setNodesVisibility(t,e)}async setOpacity(e){let t=this._itemsToSelections();this._viewer.model.setNodesOpacity(t,e)}async colorize(e){let t=this._itemsToSelections();await this._viewer.model.setNodesFaceColor(t,e)}isolateAll(){let e=this._itemsToSelections();this._viewer.view.isolateNodes(e)}selectAll(){let e=[];for(let t=0;t<this._items.length;t++)e.push(new Communicator.Selection.SelectionItem(parseInt(this._items[t].id)));this._viewer.selectionManager.add(e)}_itemsToSelections(){let e=[];for(let t=0;t<this._items.length;t++)e.push(parseInt(this._items[t].id));return e}findCategoryFromSearch(){let e=this._query,t=this.getItems();if(this._categoryHash=[],this._tableProperty)if("/*"==this._tableProperty.slice(-2)&&(this._tableProperty="Node Name"),"Node Name"==this._tableProperty)for(let e=0;e<t.length;e++)null==this._categoryHash[t[e].name]&&(this._categoryHash[t[e].name]={ids:[]}),this._categoryHash[t[e].name].ids.push(t[e].id);else if("Node Name (No :Ext)"==this._tableProperty)for(let e=0;e<t.length;e++){let i,r=t[e].name.lastIndexOf(":");i=r>-1?t[e].name.substring(0,r):t[e].name,null==this._categoryHash[i]&&(this._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}else if("Node Name (No -Ext)"==this._tableProperty)for(let e=0;e<t.length;e++){let i,r=t[e].name.lastIndexOf("-");i=r>-1?t[e].name.substring(0,r):t[e].name,null==SQueryResultsUI._categoryHash[i]&&(SQueryResultsUI._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}else if("Node Parent"==this._tableProperty)for(let e=0;e<t.length;e++){let i=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(t[e].id));null==this._categoryHash[i]&&(this._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}else if("Node Type"==this._tableProperty)for(let e=0;e<t.length;e++){let i=Communicator.NodeType[this._viewer.model.getNodeType(t[e].id)];null==this._categoryHash[i]&&(this._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}else{let e=this._tableProperty;for(let i=0;i<t.length;i++){let r=t[i].id;null!=this._manager._propertyHash[r][e]&&(null==this._categoryHash[this._manager._propertyHash[r][e]]&&(this._categoryHash[this._manager._propertyHash[r][e]]={ids:[]}),this._categoryHash[this._manager._propertyHash[r][e]].ids.push(t[i].id))}}else{for(let i=0;i<e.getNumConditions();i++){let o=e.getCondition(i);if(o.propertyType==r.nodeName||o.wildcardString){for(let e=0;e<t.length;e++)null==this._categoryHash[t[e].name]&&(this._categoryHash[t[e].name]={ids:[]}),this._categoryHash[t[e].name].ids.push(t[e].id);return void(this._tableProperty="Node Name")}if(o.relationship==r.nodeParent){for(let e=0;e<t.length;e++){let i=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(t[e].id));null==this._categoryHash[i]&&(this._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}return void(this._tableProperty="Node Parent")}if(o.propertyType==r.nodeType){for(let e=0;e<t.length;e++){let i=Communicator.NodeType[this._viewer.model.getNodeType(t[e].id)];null==this._categoryHash[i]&&(this._categoryHash[i]={ids:[]}),this._categoryHash[i].ids.push(t[e].id)}return void(this._tableProperty="Node Type")}if(o.propertyType==r.property){let e=o.propertyName;for(let e=0;e<t.length;e++){let i=t[e].id;null!=this._manager._propertyHash[i][o.propertyName]&&(null==this._categoryHash[this._manager._propertyHash[i][o.propertyName]]&&(this._categoryHash[this._manager._propertyHash[i][o.propertyName]]={ids:[]}),this._categoryHash[this._manager._propertyHash[i][o.propertyName]].ids.push(t[e].id))}return void(this._tableProperty=e)}}this._tableProperty="Node Name",this.findCategoryFromSearch()}}calculateAMT(e,t,i){if("sum"==i){let i=0;for(let r=0;r<t.length;r++){let o=this._manager._propertyHash[t[r]][e];null!=o&&(i+=parseFloat(o))}return i}{let r=[];for(let i=0;i<t.length;i++){let o=SQueryResultsUI._manager._propertyHash[t[i]][e];null!=o&&r.push(parseFloat(o))}if(0===r.length)return 0;if("avg"==i)return r.reduce(((e,t)=>e+t),0)/r.length;if("max"==i)return Math.max(...r);if("min"==i)return Math.min(...r);if("med"==i){r.sort(((e,t)=>e-t));const e=Math.floor(r.length/2);return r.length%2==0?(r[e-1]+r[e])/2:r[e]}}}getAMTUnit(e){let t=this._manager._allPropertiesHash[e];if(null!=t)for(let e in t){if(-1!=e.indexOf("mm²"))return"mm²";if(-1!=e.indexOf("m²"))return"m²";if(-1!=e.indexOf("mm³"))return"mm³";if(-1!=e.indexOf("m³"))return"m³";if(-1!=e.indexOf("mm"))return"mm";if(-1!=e.indexOf("m"))return"m";if(-1!=e.indexOf("inch³"))return"inch³";if(-1!=e.indexOf("inch²"))return"inch²";break}}convertColor(e){switch(e){case"red":return new Communicator.Color(255,0,0);case"green":return new Communicator.Color(0,255,0);case"blue":return new Communicator.Color(0,0,255);case"yellow":return new Communicator.Color(255,255,0);case"brown":return new Communicator.Color(150,75,0);case"black":return new Communicator.Color(0,0,0);case"white":return new Communicator.Color(255,255,255);case"orange":return new Communicator.Color(255,165,0);case"grey":return new Communicator.Color(128,128,128)}}isNumberProp(e){let t=e.toLowerCase();if(-1!=t.indexOf("version")||-1!=t.indexOf("globalid")||-1!=t.indexOf("name")||-1!=t.indexOf("date")||-1!=t.indexOf("persistentid"))return!1;let i=this._manager._allPropertiesHash[e];if(null!=i)for(let e in i){if(!isNaN(parseFloat(e)))return!0;break}return!1}getAllProperties(){let e=this._items,t=[],i=[];for(let e in this._manager._allPropertiesHash)t.push(e);for(let t=0;t<e.length;t++){let r=e[t].id;for(let e in this._manager._propertyHash[r])i[e]=!0}let r=[];for(let e=0;e<t.length;e++)null!=i[t[e]]&&r.push(t[e]);r.sort(),r.unshift("Node Parent"),r.unshift("Node Type"),r.unshift("Node Name (No -Ext)"),r.unshift("Node Name (No :Ext)"),r.unshift("Node Name");for(let e=0;e<r.length;e++)if(-1!=r[e].indexOf("Materials and Finishes/")){r.splice(e,0,"Materials and Finishes/*");break}for(let e=0;e<r.length;e++)if(-1!=r[e].indexOf("Other/")){r.splice(e,0,"Other/*");break}return r}getCategoryTableData(e,t){let i=[],r=this._query.getAutoColors();if(r)for(let e in this._categoryHash)r[e]||(r[e]=this._categoryHash[e].color);for(let o in this._categoryHash){let a=r?r[o]:null,s=o;this.isNumberProp(this.getTableProperty())&&(s=parseFloat(o));let n={name:s,num:this._categoryHash[o].ids.length,color:a?"rgba("+a.r+","+a.g+","+a.b+",1)":"",id:o};if("--EMPTY--"!=e){let i=this.calculateAMT(e,this._categoryHash[o].ids,t);n.amt=i}i.push(n)}return i}getExpandedTableData(e,t,i){let r=[];for(let o=0;o<e.length;o++){let a,s=this._viewer.model.getNodeName(e[o]);-1!=t.indexOf("Node Name")||-1!=t.indexOf("Node Type")?a=Communicator.NodeType[this._viewer.model.getNodeType(e[o])]:-1!=t.indexOf("Node Parent")?a=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(e[o])):this.isNumberProp(t)?(a=parseFloat(this._manager._propertyHash[e[o]][t]),isNaN(a)&&(a="Not Defined")):a=this._manager._propertyHash[e[o]][t],null==a&&(a="Not Defined");let n={name:s,id:e[o],prop1:a};"--EMPTY--"!=i&&(-1!=i.indexOf("Node Name")||-1!=i.indexOf("Node Type")?n.prop2=Communicator.NodeType[this._viewer.model.getNodeType(e[o])]:-1!=i.indexOf("Node Parent")?n.prop2=this._viewer.model.getNodeName(this._viewer.model.getNodeParent(e[o])):this.isNumberProp(i)?(n.prop2=parseFloat(this._manager._propertyHash[e[o]][i]),isNaN(n.prop2)&&(n.prop2="Not Defined")):(n.prop2=this._manager._propertyHash[e[o]][i],null==n.prop2&&(n.prop2="Not Defined"))),r.push(n)}return r}calculateGradientData(e,t,i){let r=e,o=this.getCategoryTableData(t,i),a=Number.MAX_VALUE,s=-Number.MAX_VALUE;for(let e=0;e<o.length;e++){let t;t="num"==r?parseInt(o[e].num):"amt"==r?parseFloat(o[e].amt):parseFloat(o[e].name),t<a&&(a=t),t>s&&(s=t)}let n=s-a;for(let e=0;e<o.length;e++){let t;t="num"==r?parseInt(o[e].num):"amt"==r?parseFloat(o[e].amt):parseFloat(o[e].name);let i=(t-a)/n*256;this._categoryHash[o[e].id].color=new Communicator.Color(i,i,i)}let l=[];for(let e in this._categoryHash)l[e]=this._categoryHash[e].color;this._query.setAutoColors(l,this._tableProperty)}caculateExpandedColorsGradient(e,t,i,r){let o=e,a=this.getExpandedTableData(t,i,r),s=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let e=0;e<a.length;e++){let t;t="prop1"==o?parseFloat(a[e].prop1):parseFloat(a[e].prop2),t<s&&(s=t),t>n&&(n=t)}let l=n-s,d=[];for(let e=0;e<a.length;e++){let t;t="prop1"==o?parseFloat(a[e].prop1):parseFloat(a[e].prop2);let i=(t-s)/l*256;d.push({id:a[e].id,colorsav:i,color:"rgba("+i+","+i+","+i+",1)"})}return d}}class n{constructor(e,t){this._manager=e,this._viewer=this._manager._viewer,this._limitselectionlist=[],this._conditions=[],this._name="",this._action=["",""],this._keepSearchingChildren=!1,this._prop=!1,this._autoColors=null,this._id=this._generateGUID(),this._searchCounter=0,this._autoColorsProperty=null,this._startnode=t||this._viewer.model.getRootNode()}getAction(e=0){return this._action[e]}setAction(e,t=0){this._action[t]=e}hasAction(){return""!=this._action[0]||""!=this._action[1]}setAutoColors(e=null,t=null){this._autoColors=e,this._autoColorsProperty=t}getAutoColors(){return this._autoColors}getAutoColorProperty(){return this._autoColorsProperty}async performAction(e,t=!0){if(""==this._action[0]&&""==this._action[1])return;let i;i=e||await this.apply();for(let e=0;e<2;e++){let r=[];if(t||"Isolate"==this._action[e])r=i;else for(let e=0;e<i.length;e++)this._viewer.model.getBranchVisibility(i[e])&&r.push(i[e]);switch(this._action[e]){case"red":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(255,0,0));break;case"green":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(0,255,0));break;case"blue":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(0,0,255));break;case"yellow":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(255,255,0));break;case"grey":await this._viewer.model.setNodesFaceColor(r,new Communicator.Color(128,128,128));break;case"Transparent":await this._viewer.model.setNodesOpacity(r,.25);break;case"Opaque":await this._viewer.model.setNodesOpacity(r,1);break;case"Isolate":await this._viewer.view.isolateNodes(r,0,!1);break;case"Show":await this._viewer.model.setNodesVisibility(r,!0);break;case"Hide":await this._viewer.model.setNodesVisibility(r,!1);break;case"Auto Color":await this.autoColorAction(r);break;case"Select":let e=[];for(let t=0;t<r.length;t++)e.push(new Communicator.Selection.SelectionItem(r[t]));await this._viewer.selectionManager.add(e)}}}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}updateConditions(e){this._conditions=e}setProp(e){this._prop=e}getProp(){return this._prop}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){if(1==this._conditions.length&&this._conditions[0].childFilter){let e=this._conditions[0].childFilter;this._conditions.splice(0,1);for(let t=0;t<e._conditions.length;t++)this._conditions.unshift(e._conditions[t])}else this._conditions.splice(e,1)}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let i=new a;i.fromJSON(e.conditions[t]),this._conditions.push(i)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new n(this._manager,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}if(this._name=e.name,null==e.prop?this._prop=!1:this._prop=e.prop,null==e.action?this._action=["",""]:this._action=JSON.parse(JSON.stringify(e.action)),null==e.keepSearchingChildren?this._keepSearchingChildren=!1:this._keepSearchingChildren=e.keepSearchingChildren,e.id&&(this._id=e.id),e.autoColors){this._autoColorsProperty=e.autoColorsProperty,this._autoColors=[];for(let t=0;t<e.autoColors.length;t++)this._autoColors[e.autoColors[t].name]=new Communicator.Color(e.autoColors[t].r,e.autoColors[t].g,e.autoColors[t].b)}}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let i=this._conditions[t].toJSON(this._manager);this._conditions[t].childFilter&&(i.childFilter=this._conditions[t].childFilter.toJSON()),e.push(i)}let t=null;if(this._autoColors){t=[];for(let e in this._autoColors){let i=this._autoColors[e];i&&t.push({name:e,r:i.r,g:i.g,b:i.b})}}return{autoColorsProperty:this._autoColorsProperty,autoColors:t,action:this._action,conditions:e,name:this._name,id:this._id,keepSearchingChildren:this._keepSearchingChildren,prop:this._prop}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getLimitSelectionList(){return this._limitselectionlist}getStartNode(){return this._startnode}async apply(){this._selectionBounds=null,this._searchCounter=0;let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"'),"/*"==e[t].propertyName.slice(-2)?e[t].wildcardString=e[t].propertyName.slice(0,-2):e[t].wildcardString=null,e[t].wildcardArray=null;let i=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._startnode,""):await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._viewer.model.getNodeParent(this._startnode),"");else for(let r=0;r<t.length;r++)await this._gatherMatchingNodesRecursive(e,t[r],i,this._viewer.model.getNodeParent(t[r]),"");return i}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions,"")}async findAllPropertiesOnNode(e,t,i,o){let a,s,n;t?(a=t,s=i,n=o):(a=this._conditions,s=[],n=[]);for(let t=0;t<a.length;t++)if(a[t].childFilter)await this.findAllPropertiesOnNode(e,a[t].childFilter._conditions,s,n);else if(a[t].propertyType==r.property){let i=this._manager._propertyHash[e];i[a[t].propertyName]&&!n[a[t].propertyName]&&(n[a[t].propertyName]=!0,s.push({name:a[t].propertyName,value:i[a[t].propertyName]}))}return s}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":(this._conditions[t].relationship&&(e+="Rel:"+a.convertEnumRelationshipTypeToString(this._conditions[t].relationship)+"("),this._conditions[t].propertyType==r.SQuery&&(e+="("),e+=this._conditions[t].propertyName+" "+a.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text,this._conditions[t].propertyType==r.SQuery&&(e+=")"),this._conditions[t].relationship&&(e+=")"));return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryCondition(e,t){let r,o=this._viewer.model.getBimIdFromNode(e);if(this._manager._spaceBoundaryHash[e]?r=this._manager._spaceBoundaryHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,o,Communicator.RelationshipType.SpaceBoundary),this._manager._spaceBoundaryHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e),o=[];o.push(t);let a=t.relationship;t.relationship=!1;for(let e=0;e<r.length;e++)if(await this._testNodeAgainstConditions(parseInt(r[e])+i,o,""))return t.relationship=a,!0;t.relationship=a}else if(t.conditionType==i.notExists)return!0;return!1}async _checkNodeParentCondition(e,t){let i=this._viewer.model.getNodeParent(e),r=this._viewer.model.getNodeIdOffset(e),o=[];o.push(t);let a=t.relationship;return t.relationship=!1,await this._testNodeAgainstConditions(i+r,o,"")?(t.relationship=a,!0):(t.relationship=a,!1)}async _checkNodeChildrenCondition(e,t){let i=this._viewer.model.getNodeChildren(e);if(i.length>0){let r=this._viewer.model.getNodeIdOffset(e),o=[];o.push(t);let a=t.relationship;t.relationship=!1;for(let e=0;e<i.length;e++)if(await this._testNodeAgainstConditions(i[e]+r,o,""))return t.relationship=a,!0;t.relationship=a}return!1}async _checkAggregateCondition(e,t){let r,o=this._viewer.model.getBimIdFromNode(e);if(this._manager._aggregateHash[e]?r=this._manager._aggregateHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,o,Communicator.RelationshipType.Aggregates),this._manager._aggregateHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e),o=[];o.push(t);let a=t.relationship;t.relationship=!1;for(let e=0;e<r.length;e++)if(await this._testNodeAgainstConditions(parseInt(r[e])+i,o,""))return t.relationship=a,!0;t.relationship=a}else if(t.conditionType==i.notExists)return!0;return!1}async _checkContainedInCondition(e,t){let r,o=this._viewer.model.getBimIdFromNode(e);if(this._manager._containedInSpatialStructureHash[e]?r=this._manager._containedInSpatialStructureHash[e]:(r=this._viewer.model.getBimIdRelatingElements(e,o,Communicator.RelationshipType.ContainedInSpatialStructure),this._manager._containedInSpatialStructureHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e),o=[];o.push(t);let a=t.relationship;t.relationship=!1;for(let e=0;e<r.length;e++)if(await this._testNodeAgainstConditions(parseInt(r[e])+i,o,""))return t.relationship=a,!0;t.relationship=a}else if(t.conditionType==i.notExists)return!0;return!1}_evaluateComparison(e){const t=e.match(/^\s*(-?\d+(?:\.\d+)?)\s*([<>]=?)\s*(-?\d+(?:\.\d+)?)\s*$/);if(!t)return!1;const i=parseFloat(t[1]),r=t[2],o=parseFloat(t[3]);switch(r){case"<":return i<o;case">":return i>o;case"<=":return i<=o;case">=":return i>=o;default:return!1}}_extractCoordinates(e){const t=e.match(/x:([\d,\-]+(\.\d+)?)\s*y:([\d,\-]+(\.\d+)?)\s*z:([\d,\-]+(\.\d+)?)/);if(t){const e=parseFloat(t[1].replace(",","")),i=parseFloat(t[3].replace(",","")),r=parseFloat(t[5].replace(",",""));return new Communicator.Point3(e,i,r)}}async _checkCondition(e,t,o){if(t.conditionType!=i.contains){if(t.conditionType==i.exists)return!(!this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]);if(t.conditionType==i.notExists)return!(!this._manager._propertyHash[e]||null!=this._manager._propertyHash[e][t.propertyName]);let o;if(t.propertyType==r.nodeName)o=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==r.nodeId)o=e;else if(t.propertyType==r.numChildren)o=this._viewer.model.getNodeChildren(e).length;else{if(t.conditionType==i.evaluate){let i;if("COG"==t.propertyName){let r=this._manager._propertyHash[e][t.propertyName];if(!r)return!1;let o=this._extractCoordinates(r);i=new Communicator.Box(o,o)}else{try{i=await this._viewer.model.getNodesBounding([e])}catch(e){return!1}if(-1!=t.text.indexOf("bounds:")){let e=t.text.replace("bounds:","").split(" ");return i.min.x>=parseFloat(e[0])&&i.min.y>=parseFloat(e[1])&&i.min.z>=parseFloat(e[2])&&i.max.x<=parseFloat(e[3])&&i.max.y<=parseFloat(e[4])&&i.max.z<=parseFloat(e[5])}}let r=t.text.split(","),o=0;for(let e=0;e<r.length;e++)if(-1!=r[e].indexOf("x")){let t;t=-1!=r[e].indexOf(">")?r[e].replace("x",i.min.x.toString()):r[e].replace("x",i.max.x.toString()),this._evaluateComparison(t)&&o++}else if(-1!=r[e].indexOf("y")){let t;t=-1!=r[e].indexOf(">")?r[e].replace("y",i.min.y.toString()):r[e].replace("y",i.max.y.toString()),this._evaluateComparison(t)&&o++}else if(-1!=r[e].indexOf("z")){let t;t=-1!=r[e].indexOf(">")?r[e].replace("z",i.min.z.toString()):r[e].replace("z",i.max.z.toString()),this._evaluateComparison(t)&&o++}return!(!o||o!=r.length)}{let r;if(this._manager._propertyHash[e]&&(r=this._manager._propertyHash[e][t.propertyName]),null==r)return t.conditionType==i.unequal;o=parseFloat(r)}}if(t.conditionType==i.greaterOrEqualDate||t.conditionType==i.lessOrEqualDate){let r;if(this._manager._propertyHash[e]&&(r=this._manager._propertyHash[e][t.propertyName]),null==r)return!1;-1!=r.indexOf(" ")||isNaN(parseInt(r))||(r=parseInt(r));let o=new Date(r);if(isNaN(o.getDate()))return!1;let a=t.text;-1!=a.indexOf(" ")||isNaN(parseInt(a))||(a=parseInt(a));let s=new Date(a);if(t.conditionType==i.greaterOrEqualDate){if(o>=s)return!0}else if(t.conditionType==i.lessOrEqualDate&&o<=s)return!0;return!1}{let e=parseFloat(t.text);if(isNaN(e)||isNaN(o))return!1;if(t.conditionType==i.greaterOrEqual){if(o>=e)return!0}else if(t.conditionType==i.lessOrEqual){if(o<=e)return!0}else if(t.conditionType==i.unequal){if(o!=e)return!0}else if(o==e)return!0;return!1}}{let i=t.text.split(","),a="";if(t.propertyType==r.nodeName)a=this._viewer.model.getNodeName(e);else if(t.propertyType==r.relationship)a=o;else if(t.propertyType==r.nodeChain)a=o||s.createChainText(this._viewer,e,this._viewer.model.getRootNode(),0);else if(t.propertyType==r.numChildren){let t=this._viewer.model.getNodeChildren(e);for(let e=0;e<t.length;e++)a+=this._viewer.model.getNodeName(t[e])}else if(t.propertyType==r.nodeType)a=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==r.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)a="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);a=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else a=t.propertyType==r.nodeId?e.toString():t.propertyType==r.ifcglobalid?hwv.model.getGenericIdFromBimId(e,e.toString()):null==this._manager._propertyHash[e]||null==this._manager._propertyHash[e][t.propertyName]?void 0:this._manager._propertyHash[e][t.propertyName];null==a&&(a="");let n=0,l=0,d=0,u=0,c=0;for(let e=0;e<i.length;e++){let o,s;if('"'==i[e][0]||'"'==i[e][1])if(o=!0,'"'==i[e][0])s=i[e].substring(1,i[e].length-1);else{let t=i[e][0];s=i[e].substring(2,i[e].length-1),s=t+s}else s=i[e],o=!1;if(t.propertyType==r.nodeId&&(o=!0),""==s||1==s.length&&("+"==s[0]||"-"==s[0]))return;"+"==s[0]?(l++,o?a.toLowerCase()==s.substring(1).toLowerCase()&&n++:-1!=a.toLowerCase().indexOf(s.substring(1).toLowerCase())&&n++):"-"==s[0]?(d++,o?a.toLowerCase()!=s.substring(1).toLowerCase()&&u++:-1==a.toLowerCase().indexOf(s.substring(1).toLowerCase())&&u++):o?a.toLowerCase()==s.toLowerCase()&&c++:-1!=a.toLowerCase().indexOf(s.toLowerCase())&&c++}return l==n&&d==u&&(c>0||n+u==i.length)}}async _testNodeAgainstConditions(e,t,s){let n=0,l=!1;t.length>1&&!t[1].and&&(l=!0);for(let d=0;d<t.length;d++){let u;if(t[d].relationship)t[d].relationship==o.spaceBoundary?u=await this._checkSpaceBoundaryCondition(e,t[d]):t[d].relationship==o.containedIn?u=await this._checkContainedInCondition(e,t[d]):t[d].relationship==o.aggregate?u=await this._checkAggregateCondition(e,t[d]):t[d].relationship==o.nodeParent?u=await this._checkNodeParentCondition(e,t[d]):t[d].relationship==o.nodeChildren&&(u=await this._checkNodeChildrenCondition(e,t[d]));else if(t[d].propertyType==r.SQuery){if(!t[d].SQuery)if(t[d].SQueryID)t[d].SQuery=this._manager.getSQueryByID(t[d].SQueryID);else{let e=this._manager.getSQueryByName(t[d].text);t[d].SQueryID=e._id,t[d].SQuery=e}u=await this._testNodeAgainstConditions(e,t[d].SQuery._conditions,s),t[d].conditionType==i.unequal&&(u=!u)}else if(t[d].wildcardString){if(!t[d].wildcardArray){t[d].wildcardArray=[];for(let e in this._manager._allPropertiesHash)-1!=e.indexOf(t[d].wildcardString)&&-1==e.indexOf("/*")&&t[d].wildcardArray.push(e)}let r=new a;r.propertyType=t[d].type,r.text=t[d].text,r.conditionType=t[d].conditionType;let o=0;for(let a=0;a<t[d].wildcardArray.length;a++)if(r.propertyName=t[d].wildcardArray[a],u=await this._checkCondition(e,r,s),1==u){if(r.conditionType==i.contains||r.conditionType==i.exists)break;o++}r.conditionType==i.notExists&&(u=o==t[d].wildcardArray.length)}else u=t[d].childFilter?await this._testNodeAgainstConditions(e,t[d].childFilter._conditions,s):await this._checkCondition(e,t[d],s);if(0==u){if(!l)break}else n++}return!!(!l&&n==t.length||l&&n>0)}async _gatherMatchingNodesRecursive(e,t,i,r,o){if(this._searchCounter++,this._searchCounter%1500==0&&await new Promise((e=>setTimeout(e,1))),this._manager.getSearchVisible()&&!this._viewer.model.getBranchVisibility(t))return;let a=this._viewer.model.getNodeName(t)+">";if(t!=r&&await this._testNodeAgainstConditions(t,e,o)&&(i.push(t),null!=this._manager.getKeepSearchingChildren()?!this._manager.getKeepSearchingChildren():!this._keepSearchingChildren))return;let s=this._viewer.model.getNodeChildren(t);for(let t=0;t<s.length;t++)await this._gatherMatchingNodesRecursive(e,s[t],i,r,o+a)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}async autoColorAction(e){if(this._autoColors){let t=[],i=this._autoColorsProperty;if(i)if("Node Name"==i)for(let i=0;i<e.length;i++){let r=this._viewer.model.getNodeName(e[i]);null==t[r]&&(t[r]={ids:[]}),t[r].ids.push(e[i])}else{let r=i;for(let i=0;i<e.length;i++){let o=e[i];null!=this._manager._propertyHash[o][r]&&(null==t[this._manager._propertyHash[o][r]]&&(t[this._manager._propertyHash[o][r]]={ids:[]}),t[this._manager._propertyHash[o][r]].ids.push(e[i]))}}for(let e in t)this._autoColors[e]&&await this._viewer.model.setNodesFaceColor(t[e].ids,this._autoColors[e])}}}class l{constructor(e){this._viewer=e,this._SQuerys=[],this._modelHash=[],this._keepSearchingChildren=!0,this._searchVisible=!1,this._ignoreBodies=!1}setIgnoreBodies(e){this._ignoreBodies=e}getIgnoreBodies(){return this._ignoreBodies}setSearchVisible(e){this._searchVisible=e}getSearchVisible(){return this._searchVisible}addSQuery(e){this._SQuerys.push(e)}async executeSQueries(){await this._viewer.model.reset(),await this._viewer.model.unsetNodesFaceColor([this._viewer.model.getAbsoluteRootNode()]),await this._viewer.selectionManager.clear();for(let e=0;e<this._SQuerys.length;e++)await this._SQuerys[e].performAction(null,!1)}setSQueries(e){this._SQuerys=e}setKeepSearchingChildren(e){this._keepSearchingChildren=e}getKeepSearchingChildren(){return this._keepSearchingChildren}getSQuerys(){return this._SQuerys}getSQueryByName(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t].getName()==e)return this._SQuerys[t]}getSQueryByID(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t]._id==e)return this._SQuerys[t]}getSQueryNum(){return this._SQuerys.length}getSQuery(e){return this._SQuerys[e]}getSQueryID(e){return this._SQuerys[e]._id}removeSQuery(e){for(let t=0;t<this._SQuerys.length;t++)if(this._SQuerys[t]._id==e)return this._SQuerys.splice(t,1)}updateSQuery(e,t){this._SQuerys[e]=t}updateSQueryIsProp(e,t){for(let i=0;i<this._SQuerys.length;i++)this._SQuerys[i]._id==e&&this._SQuerys[i].setProp(t)}toJSON(){let e=[];for(let t=0;t<this._SQuerys.length;t++)e.push(this._SQuerys[t].toJSON());return e}fromJSON(e){this._SQuerys=[];for(let t=0;t<e.length;t++){let i=new n(this);i.fromJSON(e[t]),this.addSQuery(i)}return e}async evaluateProperties(e){let t=[];for(let i=0;i<this._SQuerys.length;i++)if(this._SQuerys[i].getProp()){let r=this._SQuerys[i],o=!1;if(null!=this._keepSearchingChildren?!this._keepSearchingChildren:!r._keepSearchingChildren){let t=e;for(;t=this._viewer.model.getNodeParent(t),t!=this._viewer.model.getRootNode();)if(await r.testOneNodeAgainstConditions(t)){o=!0;break}}if(o)continue;if(await r.testOneNodeAgainstConditions(e)){let i=await r.findAllPropertiesOnNode(e),o=r.getName();""==o&&(o=r.generateString()),t.push({name:o,properties:i})}}return t}_getModelTreeIdsRecursive(e,t,i){if(this._ignoreBodies&&this._viewer.model.getNodeType(e)==Communicator.NodeType.BodyInstance)return;t.push(this._viewer.model.getNodeProperties(e)),i.push(e);let r=this._viewer.model.getNodeChildren(e);for(let e=0;e<r.length;e++)this._getModelTreeIdsRecursive(r[e],t,i)}addModel(e,t,i){for(let i=0;i<this._modelHash.length;i++)if(this._modelHash[i].id==e)return void(this._modelHash[i].nodeid=t);this._modelHash.push({id:e,nodeid:t,savedHash:i,ids:null,properties:null})}_updateHashes(e,t,i){for(let r=0;r<t.length;r++){this._propertyHash[e[r]]=t[r];let o=this._viewer.model.getNodeLayerId(e[r]);if(null!=o&&i.size>1)if(null==this._propertyHash[e[r]]&&(this._propertyHash[e[r]]=[]),3==this._viewer.model.getNodeType(e[r])){let t=this._viewer.model.getNodeParent(e[r]);null==this._propertyHash[t]&&(this._propertyHash[t]=[]),this._propertyHash[t].LAYER=i.get(o)}else this._propertyHash[e[r]].LAYER=i.get(o);for(let e in t[r])this._allPropertiesHash[e]=[],null==this._allPropertiesHashNum[e]?this._allPropertiesHashNum[e]=1:this._allPropertiesHashNum[e]++}for(let e in this._propertyHash)for(let t in this._propertyHash[e]){if(this._propertyHash[e][t]=this._propertyHash[e][t].replace(/,/g,""),"OWNERHISTORY/CreationDate"==t||"OWNERHISTORY/LastModifiedDate"==t){let i=new Date(0);i.setUTCSeconds(parseInt(this._propertyHash[e][t])),this._propertyHash[e][t]=i.toDateString()}this._allPropertiesHash[t][this._propertyHash[e][t]]=!0}}parseSavedPropertyHash(e){let t=e.allprops,i=e.nodeprops,r=e.related,o=[],a=[];for(let e=0;e<i.length;e++){let r=i[e];a.push(r.i);let s={},n=r.p;for(let e=0;e<n.length;e+=2)s[t[n[e]].name]=t[n[e]].values[n[e+1]];o.push(s)}let s=[],n=[],l=[];if(r)for(let e=0;e<r.length;e++){let t=r[e];t.e?s[parseInt(t.i)]=t.e:s[parseInt(t.i)]=[],t.f?n[parseInt(t.i)]=t.f:n[parseInt(t.i)]=[],t.g?l[parseInt(t.i)]=t.g:l[parseInt(t.i)]=[]}return{ids:a,props:o,relatedSpaceBoundary:s,relatedContainedIn:n,relatedAggregateIn:l}}gatherRelatedDataHashesRecursive(e,t){let i=this._viewer.model.getBimIdFromNode(e),r={i:e},o=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.SpaceBoundary),a=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.ContainedInSpatialStructure),s=this._viewer.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.Aggregates);o&&o.length>0&&(r.e=o),a&&a.length>0&&(r.f=a),s&&s.length>0&&(r.g=s),t.push(r);let n=this._viewer.model.getNodeChildren(e);for(let e=0;e<n.length;e++)this.gatherRelatedDataHashesRecursive(n[e],t)}exportPropertyHash(){let e=[],t=[],i=[];for(let t in this._allPropertiesHash){let r={name:t,values:Object.keys(this._allPropertiesHash[t])},o=[];for(let e=0;e<r.values.length;e++)o[r.values[e]]=e;r.ehash=o,e.push(r),i[t]=e.length-1}for(let r in this._propertyHash){let o=[];for(let t in this._propertyHash[r]){let a=e[i[t]];o.push(i[t],a.ehash[this._propertyHash[r][t]])}t.push({i:r,p:o})}for(let t=0;t<e.length;t++)e[t].ehash=void 0;return this.gatherRelatedDataHashesRecursive(this._viewer,this._viewer.model.getRootNode(),[]),{allprops:e,nodeprops:t}}_consolidateBodies(){let e=[];for(let t in this._propertyHash)3==this._viewer.model.getNodeType(parseInt(t))&&this._propertyHash[t].Volume&&(e[this._viewer.model.getNodeParent(parseInt(t))]=!0);for(let t in e){let e=this._viewer.model.getNodeChildren(parseInt(t)),i=0,r=0;for(let t=0;t<e.length;t++){let o=e[t];this._propertyHash[o]&&this._propertyHash[o].Volume&&(i+=parseFloat(this._propertyHash[o].Volume)),this._propertyHash[o]&&this._propertyHash[o]["Surface Area"]&&(r+=parseFloat(this._propertyHash[o]["Surface Area"]))}if(i+="mm³",r+="mm²",this._propertyHash[t].Volume=i,this._propertyHash[t]["Surface Area"]=r,this._viewer.model.getNodeName(parseInt(t)).startsWith("Product")){let e=this._viewer.model.getNodeParent(parseInt(t));this._propertyHash[e].Volume=i,this._propertyHash[e]["Surface Area"]=r}}}async initialize(){this._propertyHash=[],this._allPropertiesHash=[],this._allPropertiesHashNum=[],this._containedInSpatialStructureHash=[],this._aggregateHash=[],this._spaceBoundaryHash=[];let e=this._viewer.model.getLayers();if(0==this._modelHash.length){let t=[],i=[];this._getModelTreeIdsRecursive(this._viewer.model.getRootNode(),t,i);let r=await Promise.all(t);this._updateHashes(i,r,e),this._consolidateBodies()}else for(let t=0;t<this._modelHash.length;t++){let i=this._modelHash[t],r=[],o=null,a=this._viewer.model.getNodeIdOffset(i.nodeid);if(i.ids){for(let e=0;e<i.ids.length;e++)r.push(i.ids[e]+a);o=i.properties}else{let e=[];if(i.savedHash){let e=this.parseSavedPropertyHash(i.savedHash);o=e.props,r=e.ids,this._containedInSpatialStructureHash=e.relatedContainedIn,this._aggregateHash=e.relatedAggregateIn,this._spaceBoundaryHash=e.relatedSpaceBoundary}else this._getModelTreeIdsRecursive(i.nodeid,e,r),o=await Promise.all(e);i.properties=o,i.ids=[];for(let e=0;e<r.length;e++)i.ids.push(r[e]-a)}this._updateHashes(r,o,e)}}getAllOptionsForProperty(e){return this._allPropertiesHash[e]}getNumOptions(e){if(null!=this._allPropertiesHash[e])return Object.keys(this._allPropertiesHash[e]).length}getNumOptionsUsed(e){if(null!=this._allPropertiesHash[e])return this._allPropertiesHashNum[e]}getAllProperties(e=!1){let t=[],i=!1;!e&&this._allPropertiesHash.TYPE&&(i=!0);let r=!1;this._allPropertiesHash.LAYER&&(r=!0);let o=!1;this._allPropertiesHash["Surface Area"]&&(o=!0);let a=!1;this._allPropertiesHash.Volume&&(a=!0);for(let i in this._allPropertiesHash)"TYPE"==i&&!e||"LAYER"==i||"Surface Area"==i||"Volume"==i||t.push(i);t.sort(),t.unshift("---"),e||(t.unshift("IFC GlobalId"),t.unshift("Rel:IFC SpaceBoundary"),t.unshift("Rel:IFC Aggregate"),t.unshift("Rel:IFC ContainedIn"),i&&t.unshift("TYPE"),t.unshift("---")),t.unshift("Rel:Node Children"),t.unshift("Rel:Node Parent"),t.unshift("SQuery"),t.unshift("Bounding"),t.unshift("# Children"),r&&t.unshift("LAYER"),o&&t.unshift("Surface Area"),a&&t.unshift("Volume"),t.unshift("Node Color"),t.unshift("Node Type"),t.unshift("Node Chain"),t.unshift("Nodeid"),t.unshift("Node Name");for(let e=0;e<t.length;e++)if(-1!=t[e].indexOf("Materials and Finishes/")){t.splice(e,0,"Materials and Finishes/*");break}for(let e=0;e<t.length;e++)if(-1!=t[e].indexOf("Other/")){t.splice(e,0,"Other/*");break}return t}}class d{static initialize(e,t){d._maindiv=e,d._manager=t,d._viewer=t._viewer,d._isPropertyView=!1,d._tablePropertyAMT="--EMPTY--",d._aggType="sum",d._tablePropertyExpanded1="--EMPTY--",d._tablePropertyExpanded2="--EMPTY--",d._viewer.setCallbacks({selectionArray:function(e,t){d._isPropertyView||d.generateSearchResults(u._founditems)}})}static async display(){let e="";e+='<div id = "SQueryResultsUIFirstRow" style="position:relative;width:100%;height:15px;top:-8px">',e+='<div style="position:absolute; left:3px;top:5px; font-size:14px;background-color:white" id="'+d._maindiv+'_found"></div>',e+=d._generateDropdown(),e+='<button class="SQuerySearchButton" type="button" style="right:5px;top:3px;position:absolute;" onclick=\'hcSQuery.SQueryEditorUI.selectAll(this)\'>Select</button>',e+='<button id="SQueryToggleViewButton" class="SQuerySearchButton" type="button" style="right:90px;top:3px;position:absolute;" onclick=\'hcSQuery.SQueryResultsUI.toggleView(this)\'>Property View</button>',e+="</div>",e+='<div id="'+d._maindiv+'_searchitems" class="SQuerySearchItems">',e+="</div>",e+='<div style="position:absolute; right:20px;bottom:0px; font-size:12px;background-color:white" id="'+d._maindiv+'_found"></div>',$("#"+d._maindiv).empty(),$("#"+d._maindiv).append(e);const t=document.querySelector("#SQueryResultsUIDropdown"),i=document.querySelector("#SQueryResultsUIDropdownContent");t.addEventListener("click",(function(){i.classList.toggle("SQueryDropdowShow")})),window.addEventListener("click",(function(e){e.target.matches(".SQueryDropdow-button")||i.classList.contains("SQueryDropdowShow")&&i.classList.remove("SQueryDropdowShow")}))}static getAmountStrings(e){let t=[];t.push("--EMPTY--");for(let i=0;i<e.length;i++){let r=e[i].toLowerCase();if(-1!=r.indexOf("version")||-1!=r.indexOf("globalid")||-1!=r.indexOf("name")||-1!=r.indexOf("date")||-1!=r.indexOf("persistentid"))continue;let o=d._manager._allPropertiesHash[e[i]];if(null!=o)for(let r in o){isNaN(parseFloat(r))||t.push(e[i]);break}}return t}static _propertySelected(){d._results.setTableProperty($("#SQueryPropSelect")[0].value),u._mainFilter.setAutoColors(null,null),d._generatePropertyView()}static _propertyExpandedSelected(e){0==e?d._tablePropertyExpanded0=$("#SQueryPropExpandedSelect0")[0].value:1==e&&(d._tablePropertyExpanded1=$("#SQueryPropExpandedSelect1")[0].value),d.generateExpandedResults()}static _propertyAggTypeSelected(){d._aggType=$("#SQueryPropAggType")[0].value,d._generatePropertyView()}static _propertyAMTSelected(){d._tablePropertyAMT=$("#SQueryPropSelectAMT")[0].value,d._generatePropertyView()}static applyColors(){let e=u._mainFilter.getAutoColors();if(e)for(let t in d._results.getCategoryHash())e[t]&&u._viewer.model.setNodesFaceColor(d._results.getCategoryHash()[t].ids,e[t])}static _assignColorsMainGradient(){let e=d._table.getRows(),t=256/e.length;for(let i=0;i<e.length;i++){let r=t*e[i].getPosition();d._results.getCategoryHash()[e[i].getData().id].color=new Communicator.Color(r,r,r)}let i=[];for(let e in d._results.getCategoryHash())i[e]=d._results.getCategoryHash()[e].color;u._mainFilter.setAutoColors(i,d._results.getTableProperty()),d._updateColorsInTable()}static _updateColorsInTable(){let e=[];for(let t in d._results.getCategoryHash()){let i=d._results.getCategoryHash()[t].color,r={color:"rgba("+i.r+","+i.g+","+i.b+",1)",id:t};e.push(r)}d._table.updateData(e)}static _assignExpandedColorsGradient(e){let t=d._results.caculateExpandedColorsGradient(e,this._expandedNodeIds,this._tablePropertyExpanded0,this._tablePropertyExpanded1);d._table.updateData(t)}static applyExpandedColors(){let e=d._table.getRows();for(let t=0;t<e.length;t++){let i=e[t].getData().colorsav;u._viewer.model.setNodesFaceColor([e[t].getData().id],new Communicator.Color(i,i,i))}}static _assignColorsGradient(e){let t=e;if("name"==e){if(!d._results.isNumberProp(d._results.getTableProperty()))return void d._assignColorsMainGradient();t=d._results.getTableProperty()}d._results.calculateGradientData(t,d._tablePropertyAMT,d._aggType),d._updateColorsInTable()}static assignColorsRandom(){for(let e in d._results.getCategoryHash()){let t=new Communicator.Color(Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random()));d._results.getCategoryHash()[e].color=t}let e=[];for(let t in d._results.getCategoryHash())e[t]=d._results.getCategoryHash()[t].color;u._mainFilter.setAutoColors(e,d._results.getTableProperty()),d._updateColorsInTable()}static _clearColors(){u._mainFilter.setAutoColors(null,null);let e=[];for(let t in d._results.getCategoryHash()){d._results.getCategoryHash()[t].color=void 0;let i={color:null,id:t};e.push(i)}d._table.updateData(e)}static _generatePropertyView(e=!1){$("#SQueryResultsUIFirstRow").css("display","block"),u._mainFilter.getAutoColorProperty()&&d._results.setTableProperty(u._mainFilter.getAutoColorProperty());let t=d._results.getAllProperties();if(!e){let e=!1;if(d._results.getTableProperty())for(let i=0;i<t.length;i++)if(t[i]==d._results.getTableProperty()){e=!0;break}e||d._results.setTableProperty(null),d._results.findCategoryFromSearch()}$("#SQueryToggleViewButton").html("Search View"),$("#"+d._maindiv+"_searchitems").empty(),$("#"+d._maindiv+"_searchitems").css("overflow","inherit"),$("#"+d._maindiv+"_found").empty();let i=d.getAmountStrings(t),r='<div style="height:25px;"><span style="top:-16px;position:relative"><span style="font-family:courier">Prop:</span><select id="SQueryPropSelect" onchange=\'hcSQuery.SQueryResultsUI._propertySelected();\' class="SQueryPropertyResultsSelect" value="">';for(let e=0;e<t.length;e++)d._results.getTableProperty()==t[e]?r+='<option value="'+t[e]+'" selected>'+t[e]+"</option>\n":r+='<option value="'+t[e]+'">'+t[e]+"</option>\n";r+="</select></span>",r+='<span style="top:4px;left:0px;position:absolute"><span style="font-family:courier">AMT :</span><select id="SQueryPropSelectAMT" onchange=\'hcSQuery.SQueryResultsUI._propertyAMTSelected();\' class="SQueryPropertyResultsSelect" value="">';for(let e=0;e<i.length;e++)d._tablePropertyAMT==i[e]?r+='<option value="'+i[e]+'" selected>'+i[e]+"</option>\n":r+='<option value="'+i[e]+'">'+i[e]+"</option>\n";r+="</select></span>",r+='<span style="top:4px;left:186px;position:absolute"><span style="font-family:courier"></span><select id="SQueryPropAggType" onchange=\'hcSQuery.SQueryResultsUI._propertyAggTypeSelected();\' class="SQueryPropertyAggTypeSelect" value="">';let o,a=["sum","avg","max","min","med"];for(let e=0;e<a.length;e++)d._aggType==a[e]?r+='<option value="'+a[e]+'" selected>'+a[e]+"</option>\n":r+='<option value="'+a[e]+'">'+a[e]+"</option>\n";r+="</select></span>",r+='<button class="SQuerySearchButton" type="button" style="right:5px;top:3px;position:absolute;" onclick="hcSQuery.SQueryResultsUI.applyColors()">Apply Colors</button>',r+="</div>",$("#"+d._maindiv+"_searchitems").append(r),$("#"+d._maindiv+"_searchitems").append('<div class = "SQueryResultsUITabulator" id = "SQueryResultsUITabulator"></div>'),-1!=d._results.getTableProperty().indexOf("Date")&&(o=function(e,t,i,r,o,a,s){let n=new Date(e),l=new Date(t);return n>l?1:n<l?-1:0});let s=[{label:"<i class='fas fa-user'></i> Assign Random Colors",action:async function(e,t){d.assignColorsRandom()}},{label:"<i class='fas fa-user'></i> Assign Gradient",action:async function(e,t){d._assignColorsGradient(t.getDefinition().field)}},{label:"<i class='fas fa-user'></i> Clear Colors",action:async function(e,t){d._clearColors()}}],n=d._results.getTableProperty();if(d._results.isNumberProp(d._results.getTableProperty())){let e=d._results.getAMTUnit(d._results.getTableProperty());e&&(n="("+e+")")}let l=[{title:n,field:"name",sorter:o,headerMenu:s},{title:"#",field:"num",width:65,bottomCalc:"sum",headerMenu:s},{title:"Color",field:"color",headerSort:!1,field:"color",editor:"list",width:45,formatter:"color",editorParams:{values:["red","green","blue","yellow","brown","orange","grey","black","white"]}},{title:"ID",field:"id",width:20,visible:!1}];if("--EMPTY--"!=d._tablePropertyAMT){let e=d._results.getAMTUnit(d._tablePropertyAMT),t="";t=e?d._aggType+"("+e+")":d._aggType,l.splice(1,0,{headerMenu:s,title:t,field:"amt",width:120,bottomCalc:"med"!=d._aggType?d._aggType:void 0})}let c=[{label:"<i class='fas fa-user'></i> View Category",action:async function(e,t){let i=d._results.getCategoryHash()[t.getData().id].ids;if("/*"==d._results.getTableProperty().slice(-2)){let e=t.getData().id.split("/");d._tablePropertyExpanded0=d._results.getTableProperty().slice(0,-2)+"/"+e[0]}else d._tablePropertyExpanded0=d._results.getTableProperty();d._tablePropertyExpanded1=d._tablePropertyAMT,d.generateExpandedResults(i)}},{label:"<i class='fas fa-user'></i> View All",action:async function(e,t){let i=u._founditems.getItems(),r=[];for(let e=0;e<i.length;e++)r.push(i[e].id);d._tablePropertyExpanded0=d._results.getTableProperty(),d._tablePropertyExpanded1=d._tablePropertyAMT,d.generateExpandedResults(r)}}];d._table=new Tabulator("#SQueryResultsUITabulator",{rowHeight:15,selectable:0,layout:"fitColumns",columns:l,rowContextMenu:c}),d._table.on("rowClick",(async function(e,t){let i=t.getData(),r=d._results.getCategoryHash()[i.id].ids;if(d._viewer.selectionManager.clear(),1==r.length)d._viewer.selectionManager.selectNode(r[0],Communicator.SelectionMode.Set);else{let e=[];for(let t=0;t<r.length;t++)e.push(new Communicator.Selection.SelectionItem(r[t]));d._viewer.selectionManager.add(e)}})),d._table.on("tableBuilt",(function(){let e=d._results.getCategoryTableData(d._tablePropertyAMT,d._aggType);d._table.setData(e)})),d._table.on("cellEdited",(function(e){if("color"==e.getField()){let t=u._mainFilter.getAutoColors();t||(t=[],u._mainFilter.setAutoColors(t,d._results.getTableProperty()));let i=e.getRow().getData();t[i.id]=d._results.convertColor(i.color)}d._table.redraw()}))}static generateExpandedResults(e=null){let t;e?(d._expandedNodeIds=e,t=e):t=d._expandedNodeIds,this._expandedNodeIds=t,-1!=d._tablePropertyExpanded0.indexOf("Node Name")&&(d._tablePropertyExpanded0="Node Type"),$("#"+d._maindiv+"_searchitems").empty(),$("#"+d._maindiv+"_searchitems").css("overflow","inherit"),$("#"+d._maindiv+"_found").empty(),$("#SQueryResultsUIFirstRow").css("display","none");let i=d._results.getAllProperties();i.shift(),i.shift();let r='<div style="height:35px;">';r+='<button class="SQuerySearchButton" type="button" style="right:5px;top:-5px;position:absolute;" onclick=\'hcSQuery.SQueryResultsUI._generatePropertyView(true)\'>Property View</button>',r+='<button class="SQuerySearchButton" type="button" style="right:5px;top:17px;position:absolute;" onclick="hcSQuery.SQueryResultsUI.applyExpandedColors()">Apply Colors</button>',r+='<div style="height:25px;"><span style="top:-5px;position:relative"><span style="font-family:courier">Prop1:</span><select id="SQueryPropExpandedSelect0" onchange=\'hcSQuery.SQueryResultsUI._propertyExpandedSelected(0);\' class="SQueryPropertyResultsSelect" value="">';for(let e=0;e<i.length;e++)d._tablePropertyExpanded0==i[e]?r+='<option value="'+i[e]+'" selected>'+i[e]+"</option>\n":r+='<option value="'+i[e]+'">'+i[e]+"</option>\n";r+="</select></span>",r+='<span style="top:15px;left:0px;position:absolute"><span style="font-family:courier">Prop2:</span><select id="SQueryPropExpandedSelect1" onchange=\'hcSQuery.SQueryResultsUI._propertyExpandedSelected(1);\' class="SQueryPropertyResultsSelect" value="">',i.unshift("--EMPTY--");for(let e=0;e<i.length;e++)d._tablePropertyExpanded1==i[e]?r+='<option value="'+i[e]+'" selected>'+i[e]+"</option>\n":r+='<option value="'+i[e]+'">'+i[e]+"</option>\n";r+="</select></span>",r+="</div>",$("#"+d._maindiv+"_searchitems").append(r),$("#"+d._maindiv+"_searchitems").append('<div class = "SQueryResultsUITabulator" id = "SQueryResultsUITabulator"></div>'),d._tablePropertyExpanded0;let o,a,s=function(e,t,i,r,o,a,s){let n=new Date(e),l=new Date(t);return"Invalid Date"==n||"Invalid Date"==l?-1:n>l?1:n<l?-1:0},n=[{label:"<i class='fas fa-user'></i> Assign Gradient",action:async function(e,t){d._assignExpandedColorsGradient(t.getDefinition().field)}}],l=[{title:"Name",field:"name"},{title:"ID",field:"id",visible:!1},{title:"Color",field:"color",headerSort:!1,field:"color",width:45,formatter:"color"}],u="";if(d._results.isNumberProp(d._tablePropertyExpanded0)){let e=d._results.getAMTUnit(d._tablePropertyExpanded0);e?(u="("+e+")",o="sum"):u=d._tablePropertyExpanded0}else u=d._tablePropertyExpanded0;if(l.splice(1,0,{headerMenu:n,title:u,field:"prop1",bottomCalc:o,sorter:-1!=d._tablePropertyExpanded0.indexOf("Date")?s:void 0}),"--EMPTY--"!=d._tablePropertyExpanded1){let e="";if(d._results.isNumberProp(d._tablePropertyExpanded1)){let t=d._results.getAMTUnit(d._tablePropertyExpanded1);t?(e="("+t+")",a="sum"):e=d._tablePropertyExpanded1}else e=d._tablePropertyExpanded1;l.splice(2,0,{headerMenu:n,title:e,field:"prop2",bottomCalc:a,sorter:-1!=d._tablePropertyExpanded1.indexOf("Date")?s:void 0})}d._table=new Tabulator("#SQueryResultsUITabulator",{rowHeight:15,selectable:!0,selectableRangeMode:"click",layout:"fitColumns",columns:l}),d._table.on("rowSelectionChanged",(async function(e,t){var i=d._table.getSelectedData();d._viewer.selectionManager.clear();let r=[];if(1==i.length)d._viewer.selectionManager.selectNode(i[0].id,Communicator.SelectionMode.Set);else{for(let e=0;e<i.length;e++)r.push(new Communicator.Selection.SelectionItem(i[e].id));d._viewer.selectionManager.add(r)}})),d._table.on("tableBuilt",(function(){let e=d._results.getExpandedTableData(t,d._tablePropertyExpanded0,d._tablePropertyExpanded1);d._table.setData(e)}))}static toggleView(){d._isPropertyView=!d._isPropertyView,d._isPropertyView?d._generatePropertyView():d.generateSearchResults(u._founditems)}static generateSearchResults(e){if(d._results=e,$("#SQueryResultsUIFirstRow").css("display","block"),$("#SQueryToggleViewButton").html("Property View"),d._isPropertyView=!1,$("#"+d._maindiv+"_searchitems").empty(),$("#"+d._maindiv+"_searchitems").css("overflow","auto"),$("#"+d._maindiv+"_found").empty(),null==e)return;let t=e.getItems();1==t.length?$("#"+d._maindiv+"_found").append(t.length+" item found"):$("#"+d._maindiv+"_found").append(t.length+" items found");let i="",r=!0,o=!1,a=t.length;t.length>2e3&&(a=2e3,o=!0);for(let e=0;e<a;e++){if(r=!r,d._viewer.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(t[e].id))){let o=d._viewer.model.getNodeParent(t[e].id);d._viewer.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(o))?i+=r?"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItemselectedIndirect">':"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItemselectedIndirect2">':i+=r?"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItemselected">':"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItemselected2">'}else i+=r?"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItem1">':"<div onclick='hcSQuery.SQueryResultsUI._select(\""+t[e].id+'")\' class="SQuerySearchItem2">';i+='<div class="SQuerySearchItemText">'+u._htmlEncode(t[e].name)+"</div>",i+='<div class="SQuerySearchItemChainText">'+u._htmlEncode(t[e].chaintext)+"</div>",i+="</div>"}o&&(i+='<div style="left:3px;" >More...</div>'),$("#"+d._maindiv+"_searchitems").append(i),d.adjust()}static adjust(){let e=$("#"+u._maindiv).height()-($("#"+d._maindiv+"_searchitems").offset().top-$("#"+u._maindiv).parent().offset().top);$("#"+d._maindiv+"_searchitems").css({height:e+"px"});let t=e+$("#"+u._maindiv+"_conditions").height()+3;u._showFirstRow&&(t+=$("#"+u._maindiv+"_firstrow").height())}static _select(e){u.ctrlPressed?d._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Toggle):d._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Set),d.generateSearchResults(u._founditems)}static _generateDropdown(){let e="";return e+='<button id="SQueryResultsUIDropdown" style="right:56px;top:3px;position:absolute;" class="SQuerySearchButton SQueryDropdow-button">...</button>',e+='<ul  id="SQueryResultsUIDropdownContent" style="right:22px;top:10px;position:absolute;" class="SQueryDropdow-content">',e+="<li onclick='hcSQuery.SQueryEditorUI.selectAll(this)'>Select</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().isolateAll(this)'>Isolate</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().makeVisible(true)'>Show</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().makeVisible(false)'>Hide</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.resetModel()'>Reset Model</li>",e+="<li >---</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(255,0,0))'>Red</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(0,255,0))'>Green</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(0,0,255))'>Blue</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(255,255,0))'>Yellow</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(128,128,128))'>Grey</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().setOpacity(0.7)'>Transparent</li>",e+="<li onclick='hcSQuery.SQueryEditorUI.getFoundItems().setOpacity(1)'>Opaque</li>",e+="</ul>","<button id=\"SQueryResultsUIDropdown\" style=\"right:56px;top:3px;position:absolute;\" class=\"SQuerySearchButton SQueryDropdow-button\">...</button><ul  id=\"SQueryResultsUIDropdownContent\" style=\"right:22px;top:10px;position:absolute;\" class=\"SQueryDropdow-content\"><li onclick='hcSQuery.SQueryEditorUI.selectAll(this)'>Select</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().isolateAll(this)'>Isolate</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().makeVisible(true)'>Show</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().makeVisible(false)'>Hide</li><li onclick='hcSQuery.SQueryEditorUI.resetModel()'>Reset Model</li><li >---</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(255,0,0))'>Red</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(0,255,0))'>Green</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(0,0,255))'>Blue</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(255,255,0))'>Yellow</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().colorize(new Communicator.Color(128,128,128))'>Grey</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().setOpacity(0.7)'>Transparent</li><li onclick='hcSQuery.SQueryEditorUI.getFoundItems().setOpacity(1)'>Opaque</li></ul>"}}class u{static _chainSkip=0;static _showLimitOption=!0;static _showFirstRow=!0;static _showPropertyStats=!0;static _hideIFCProperties=!1;static _searchResultsCallback=null;static _htmlEncode(e){return(e=$.trim(e)).replace(/[&"'\<\>]/g,(function(e){switch(e){case"&":return"&amp;";case"'":return"&#39;";case'"':return"&quot;";case"<":return"&lt;";default:return"&gt;"}}))}static initialize(e,t,i){u.ctrlPressed=!1,$(document).on("keyup keydown",(function(e){u.shiftPressed=e.shiftKey,u.ctrlPressed=e.ctrlKey})),u._maindiv=e,u._manager=t,u._viewer=t._viewer,u._mainFilter=new hcSQuery.SQuery(u._manager,i),u._mainFilter.tempId=0,new ResizeObserver((function(){u.adjust()})).observe($("#"+u._maindiv)[0]),u._searchResultsCallback||d.initialize(u._maindiv+"_resultscontainer",t)}static setHideIFCProperties(e){u._hideIFCProperties=e}static setChainSkip(e){u._chainSkip=e}static showFirstRow(e){u._showFirstRow=e}static showPropertyStats(e){u._showPropertyStats=e}static setSearchResultsCallback(e){u._searchResultsCallback=e}static _generateDropdown(){let e="";return e+='<button style="right:57px;top:3px;position:absolute;" class="SQuerySearchButton SQueryDropdow-button">...</button>',e+='<ul style="right:22px;top:10px;position:absolute;" class="SQueryDropdow-content">',e+="<li onclick='hcSQuery.SQueryEditorUI._setSearchChildren(this)'><span style=\"left:-5px;position:absolute;\">&#x2714</span>Search Children</li>",e+="<li onclick='hcSQuery.SQueryEditorUI._setSearchVisible(this)'>Search Visible</li>",e+="<li>---</li>",e+="<li onclick='hcSQuery.SQueryEditorUI._toggleLighting()'>Toggle Lighting</li>",e+="<li onclick='hcSQuery.SQueryEditorUI._viewer.model.setNodesFaceColor([hcSQuery.SQueryEditorUI._viewer.model.getRootNode()],Communicator.Color.white())'>Set to White</li>",e+="</ul>",'<button style="right:57px;top:3px;position:absolute;" class="SQuerySearchButton SQueryDropdow-button">...</button><ul style="right:22px;top:10px;position:absolute;" class="SQueryDropdow-content"><li onclick=\'hcSQuery.SQueryEditorUI._setSearchChildren(this)\'><span style="left:-5px;position:absolute;">&#x2714</span>Search Children</li><li onclick=\'hcSQuery.SQueryEditorUI._setSearchVisible(this)\'>Search Visible</li><li>---</li><li onclick=\'hcSQuery.SQueryEditorUI._toggleLighting()\'>Toggle Lighting</li><li onclick=\'hcSQuery.SQueryEditorUI._viewer.model.setNodesFaceColor([hcSQuery.SQueryEditorUI._viewer.model.getRootNode()],Communicator.Color.white())\'>Set to White</li></ul>'}static _toggleLighting(){u._viewer.view.setLightingEnabled(!u._viewer.view.getLightingEnabled())}static async display(){await u._manager.initialize();let e="";if(e+='<div class = "SQueryMain" id="'+u._maindiv+'_main">',u._showFirstRow&&(e+='<div id = "SQueryEditorUIFirstRow">',u._showLimitOption?(e+='<div id="'+u._maindiv+'_firstrow" style="position:relative;height:20px;">',e+='<button title = "Select nodes current search is limited to" id="SQUeryLimitSelectionButton" disabled style="position:relative;top:-1px"class="SQuerySearchButton" type="button" style="right:65px;top:2px;position:absolute;" onclick=\'hcSQuery.SQueryEditorUI._limitSelectionShow()\'>Limit</button><input title = "Limit search to currently selected entities" onclick=\'hcSQuery.SQueryEditorUI._limitSelection()\' style="position:relative;left:-2px;top:2px;" type = "checkbox" id="'+u._maindiv+'_searchfromselection">',e+="</div>"):e+='<div style="position:relative;height:20px;"></div>',e+=u._generateDropdown(),e+='<button class="SQuerySearchButtonImportant" type="button" style="right:5px;top:3px;position:absolute;" onclick=\'hcSQuery.SQueryEditorUI.search()\'>Search</button>',e+='<hr class="SQueryEditorUIDivider">',e+="</div>"),e+='<div id="'+u._maindiv+'_conditions" class="SQuerySearchtoolsConditions">',e+=await u._generateConditions(),e+="</div>",u._searchResultsCallback||(e+="<hr>",e+='<div id="'+u._maindiv+'_resultscontainer"</div>'),e+="</div>",$("#"+u._maindiv).empty(),$("#"+u._maindiv).append(e),u._searchResultsCallback||d.display(),u._showFirstRow){const e=document.querySelector(".SQueryDropdow-button"),t=document.querySelector(".SQueryDropdow-content");e.addEventListener("click",(function(){t.classList.toggle("SQueryDropdowShow")})),window.addEventListener("click",(function(e){e.target.matches(".SQueryDropdow-button")||t.classList.contains("SQueryDropdowShow")&&t.classList.remove("SQueryDropdowShow")}))}u._generateSearchResults(),u._addFilterFromUI(!1,0)}static getFilter(){return u._mainFilter}static adjust(){u._searchResultsCallback||d.adjust()}static flush(){$("#"+u._maindiv).empty()}static async search(e=!1){u.updateFilterFromUI(),u.clearSearchResults(),$("#SQueryEditorUIFirstRow").css("opacity",.5),$("#SQueryEditorUIFirstRow").css("pointer-events","none"),u._searchResultsCallback||$("#"+d._maindiv+"_found").append("Searching...");let t=await u._mainFilter.apply();$("#SQueryEditorUIFirstRow").css("opacity",""),$("#SQueryEditorUIFirstRow").css("pointer-events","");let i=u._mainFilter.getStartNode();u._founditems=new hcSQuery.SQueryResult(this._manager,u._mainFilter),u._founditems.generateItems(t,i,u._chainSkip),u._generateSearchResults(),e&&u._mainFilter.performAction(t)}static _getSQueryFromTempId(e){if(0==e)return u._mainFilter;for(let t=0;t<u._mainFilter.getNumConditions();t++){let i=u._mainFilter.getCondition(t);if(i.childFilter&&i.childFilter.tempId==e)return i.childFilter}}static async _updateSearch(){(u._founditems||u._mainFilter.getNumConditions())&&await u.search()}static resetModel(){this._viewer.model.reset(),this._viewer.model.unsetNodesFaceColor([this._viewer.model.getAbsoluteRootNode()]),this._viewer.selectionManager.clear()}static getFoundItems(){return u._founditems}static selectAll(){u.ctrlPressed||u._viewer.selectionManager.clear(),this._founditems.selectAll(),u._generateSearchResults()}static updateFilterFromUI(e){let t;t=e||u._mainFilter;for(let e=0;e<t.getNumConditions();e++){let i=t.getCondition(e);if(i.childFilter)this.updateFilterFromUI(i.childFilter);else{i.conditionType=hcSQuery.SQueryCondition.convertStringConditionToEnum($("#"+u._maindiv+"_propertyChoiceSelect"+e+"-"+t.tempId)[0].value),i.propertyType=hcSQuery.SQueryCondition.convertStringPropertyTypeToEnum($("#"+u._maindiv+"_propertyTypeSelect"+e+"-"+t.tempId)[0].value);let r=!1;if(i.propertyType==hcSQuery.SQueryPropertyType.relationship&&(r=!0,i.relationship=hcSQuery.SQueryCondition.convertStringToRelationshipType($("#"+u._maindiv+"_propertyTypeSelect"+e+"-"+t.tempId)[0].value),i.propertyType=hcSQuery.SQueryPropertyType.nodeName,i.propertyName="Node Name"),null!=$("#"+u._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0]&&(!i.propertyType==hcSQuery.SQueryPropertyType.SQuery?i.text=u._htmlEncode($("#"+u._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0].value):i.text=$("#"+u._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0].value),r||(i.propertyName=$("#"+u._maindiv+"_propertyTypeSelect"+e+"-"+t.tempId)[0].value),u._showPropertyStats&&i.propertyName.endsWith(")")){let e=i.propertyName.lastIndexOf("(")-1;i.propertyName=i.propertyName.substring(0,e)}}1==e?i.and="and"==$("#"+u._maindiv+"_andOrchoiceSelect"+e+"-"+t.tempId)[0].value:e>1&&(i.and="and"==$("#"+u._maindiv+"_andOrchoiceSelect1-"+t.tempId)[0].value)}}static async refreshUI(){$("#"+u._maindiv+"_conditions").empty(),$("#"+u._maindiv+"_conditions").append(await u._generateConditions()),u.adjust()}static async _andorchangedFromUI(){u.updateFilterFromUI(),await u.refreshUI()}static async _convertToChildfilter(){let e=u._mainFilter,t=new hcSQuery.SQuery(u._manager,u._mainFilter.getStartNode());for(let i=0;i<e.getNumConditions();i++){let r=e.getCondition(i);r.childFilter||(t.addCondition(r),e.removeCondition(i),i--)}if(t.getNumConditions()){let i=new hcSQuery.SQueryCondition;i.propertyName="Node Name",i.setChildFilter(t),e.addCondition(i),await u.refreshUI()}}static async _addFilterFromUI(e,t){let i;u.clearSearchResults(),u.updateFilterFromUI(),i=u._getSQueryFromTempId(t);let r=null;if(e&&(r=new hcSQuery.SQuery(u._manager,u._mainFilter.getStartNode()),r.addCondition(new hcSQuery.SQueryCondition)),i.getNumConditions()<=1){let e=new hcSQuery.SQueryCondition;e.propertyName="Node Name",e.setChildFilter(r),i.addCondition(e)}else{let e=i.getCondition(i.getNumConditions()-1),t=new hcSQuery.SQueryCondition;t.propertyName="Node Name",t.setChildFilter(r),t.setAndOr(e.getAndOr()),i.addCondition(t)}await u.refreshUI()}static _deleteFilter(e,t){u.clearSearchResults(),u.updateFilterFromUI(),u._getSQueryFromTempId(t).removeCondition(e),u.refreshUI()}static _setSearchChildren(e){u._manager.setKeepSearchingChildren(!u._manager.getKeepSearchingChildren());let t="Search Children";u._manager.getKeepSearchingChildren()&&(t='<span style="left:-5px;position:absolute;">&#x2714</span>'+t),$(e).html(t)}static _setSearchVisible(e){u._manager.setSearchVisible(!u._manager.getSearchVisible());let t="Search Visible";u._manager.getSearchVisible()&&(t='<span style="left:-5px;position:absolute;">&#x2714</span>'+t),$(e).html(t)}static _limitSelectionShow(){let e=u._mainFilter.getLimitSelectionList();u._founditems=new hcSQuery.SQueryResult(this._manager,u._mainFilter),u._founditems.generateItems(e,u._viewer.model.getRootNode(),0),u.selectAll()}static _limitSelection(){if($("#"+u._maindiv+"_searchfromselection")[0].checked){let e=[],t=u._viewer.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].getNodeId());u._mainFilter.limitToNodes(e),$("#SQUeryLimitSelectionButton").prop("disabled",!1)}else u._mainFilter.limitToNodes([]),$("#SQUeryLimitSelectionButton").prop("disabled",!0)}static clearSearchResults(){u._founditems=void 0,u._generateSearchResults()}static _generateSearchResults(){u._searchResultsCallback?u._searchResultsCallback(u._founditems):d.generateSearchResults(u._founditems)}static _generateAndOrChoiceSelect(e,t,i){if(0==t||t>1)return 0==t?e.childFilter?'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;height:20px;width:50px;max-width:50px;min-width:50px">Where:</span>':'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;width:50px;max-width:50px;min-width:50px">Where:</span>':'<span style="top:5px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">'+(e.and?"and":"or")+"</span>";{let r='<span style="top:5px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">';return r+='<select class="SQuerySearchSelect" onchange=\'hcSQuery.SQueryEditorUI._andorchangedFromUI()\' id="'+u._maindiv+"_andOrchoiceSelect"+t+"-"+i.tempId+'" value="">\n',e.and?(r+='<option value="and" selected>and</option>\n',r+='<option value="or">or</option>\n'):(r+='<option value="and">and</option>\n',r+='<option value="or" selected>or</option>\n'),r+="</select></span>\n",r}}static _generateChoiceSelect(e,t,i){let r,o='<select onchange=\'hcSQuery.SQueryEditorUI._andorchangedFromUI()\' class="SQueryAndOrSelect" id="'+u._maindiv+"_propertyChoiceSelect"+t+"-"+i.tempId+'" value="">\n';r="SQuery"==e.propertyName?["=","≠"]:"Bounding"==e.propertyName?["evaluate"]:"COG"==e.propertyName?["contains","evaluate","exists"]:["contains","exists","!exists",">=","<=",">=(Date)","<=(Date)","=","≠"];for(let t=0;t<r.length;t++)r[t]==hcSQuery.SQueryCondition.convertEnumConditionToString(e.conditionType)?o+='<option selected value="'+r[t]+'">'+r[t]+"</option>\n":o+='<option value="'+r[t]+'">'+r[t]+"</option>\n";return o+="</select>\n",o}static _clearInputField(e,t){$("#"+u._maindiv+"_modeltreesearchtext"+e+"-"+t)[0]&&($("#"+u._maindiv+"_modeltreesearchtext"+e+"-"+t)[0].value="")}static _generatePropertyTypeSelect(e,t,i){let r="<select onchange='hcSQuery.SQueryEditorUI._clearInputField("+t+","+i.tempId+');hcSQuery.SQueryEditorUI._andorchangedFromUI();\' class="SQueryPropertyTypeSelect" id="'+u._maindiv+"_propertyTypeSelect"+t+"-"+i.tempId+'" value="">\n',o=u._manager.getAllProperties(u._hideIFCProperties);if(u._showPropertyStats)for(let e=0;e<o.length;e++){u._showPropertyStats;let t=u._manager.getNumOptions(o[e]);if(t){let i=u._manager.getNumOptionsUsed(o[e]);o[e]=o[e]+" ("+t+"/"+i+")"}}let a=e.propertyName;if(u._showPropertyStats){let e=u._manager.getNumOptions(a);e&&(a=a+" ("+e+"/"+u._manager.getNumOptionsUsed(a)+")")}for(let e=0;e<o.length;e++)a==o[e]?r+='<option value="'+o[e]+'" selected>'+o[e]+"</option>\n":r+='<option value="'+o[e]+'">'+o[e]+"</option>\n";return r+="</select>\n",r}static async _updateBoundingDatalist(e){let t=[],i=hcSQuery.SQueryEditorUI._viewer.selectionManager.getResults();for(let e=0;e<i.length;e++)t.push(i[e].getNodeId());if(t.length>0){let i=await hcSQuery.SQueryEditorUI._viewer.model.getNodesBounding(t),r="bounds:"+i.min.x+" "+i.min.y+" "+i.min.z+" "+i.max.x+" "+i.max.y+" "+i.max.z;$(e).next().html('<option value="'+r+'"></option>')}else $(e).next().html('<option value=""></option>')}static async _updateColorDatalist(e){if(hcSQuery.SQueryEditorUI._viewer.selectionManager.getLast()){let t=hcSQuery.SQueryEditorUI._viewer.selectionManager.getLast().getNodeId(),i=hcSQuery.SQueryEditorUI._viewer.model.getNodeChildren(t);i.length>0&&(t=i[0]);let r=await hcSQuery.SQueryEditorUI._viewer.model.getNodesEffectiveFaceColor([t]);$(e).next().html('<option value="'+r[0].r+" "+r[0].g+" "+r[0].b+'"></option>')}else $(e).next().html('<option value=""></option>')}static async _generateInput(e,t,i){let r="";r="Bounding"==e.propertyName?'<input type="search" onfocus="hcSQuery.SQueryEditorUI._updateBoundingDatalist(this)" class = "valueinput" list="datalist'+t+"-"+i.tempId+'" id="'+u._maindiv+"_modeltreesearchtext"+t+"-"+i.tempId+'" value="'+e.text+'">\n':"Node Color"==e.propertyName?'<input type="search" onfocus="hcSQuery.SQueryEditorUI._updateColorDatalist(this)" class = "valueinput" list="datalist'+t+"-"+i.tempId+'" id="'+u._maindiv+"_modeltreesearchtext"+t+"-"+i.tempId+'" value="'+e.text+'">\n':'<input type="search" class = "valueinput" list="datalist'+t+"-"+i.tempId+'" id="'+u._maindiv+"_modeltreesearchtext"+t+"-"+i.tempId+'" value="'+e.text+'">\n',r+='<datalist id="datalist'+t+"-"+i.tempId+'">\n';let o=[];if("Node Type"==e.propertyName)for(const e in Communicator.NodeType)isNaN(parseFloat(Communicator.NodeType[e]))&&o.push(Communicator.NodeType[e]);else if("SQuery"==e.propertyName){let e=u._manager.getSQuerys();for(let t=0;t<e.length;t++)o.push(e[t].getName())}else{let t=u._manager.getAllOptionsForProperty(e.propertyName);for(let e in t)o.push(e)}o.sort();for(let t=0;t<o.length;t++)e.propertyName==o[t]?r+='<option value="'+o[t]+'" selected></option>\n':r+='<option value="'+o[t]+'"></option>\n';return r+="</datalist>\n",r}static _generateTrashBin(){let e='<div title = "Delete condition" class="icon-trash" style="float: left;">';return e+='<div class="trash-lid"></div>',e+='<div class="trash-container"></div>',e+='<div class="trash-line-1"></div>',e+='<div class="trash-line-2"></div>',e+='<div class="trash-line-3"></div>',e+="</div>",'<div title = "Delete condition" class="icon-trash" style="float: left;"><div class="trash-lid"></div><div class="trash-container"></div><div class="trash-line-1"></div><div class="trash-line-2"></div><div class="trash-line-3"></div></div>'}static async _generateConditions(e,t){let i,r="";e?i=e:(u.tempId=0,i=u._mainFilter),i.tempId=u.tempId,e&&(r+='<div class = "SQueryChildCondition" style = "position:relative;left:65px;top:-10px">');for(let t=0;t<i.getNumConditions();t++){let o=i.getCondition(t);if(o.childFilter)u.tempId++,r+="<div>",r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'hcSQuery.SQueryEditorUI._deleteFilter('+t+","+i.tempId+")'>",r+=u._generateTrashBin(),r+="</div>",r+=u._generateAndOrChoiceSelect(o,t,i),r+=await this._generateConditions(o.childFilter,t),r+="</div>";else{o.relationship&&(r+='<div class="SQueryRelationshipTag" style="left:64px;position:relative">Relationship:'+hcSQuery.SQueryCondition.convertEnumRelationshipTypeToString(o.relationship)+"</div>"),r+='<div style="height:30px;margin-top:-3px">',r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'hcSQuery.SQueryEditorUI._deleteFilter('+t+","+i.tempId+")'>",r+=u._generateTrashBin(),r+="</div>",r+=u._generateAndOrChoiceSelect(o,t,i);let a=66;e&&(a*=2),r+=1==t?'<div style="display:flex;position:relative;top:-11px;left:64px;margin-right: 1em;width:calc(100%  - '+a+'px)">':'<div style="display:flex;position:relative;top:-8px;left:64px;margin-right: 1em;width:calc(100%  - '+a+'px)">',r+=u._generatePropertyTypeSelect(o,t,i),r+=u._generateChoiceSelect(o,t,i),"exists"!=hcSQuery.SQueryCondition.convertEnumConditionToString(o.conditionType)&&"!exists"!=hcSQuery.SQueryCondition.convertEnumConditionToString(o.conditionType)?r+=await u._generateInput(o,t,i):r+='<div style="position:relative;left:5px;top:0px;width:275px"></div>',r+="</div>",r+="</div>"}}return r+='<button title = "Add new condition" class="SQuerySearchButton" type="button" style="margin-top:2px;left:2px;bottom:2px;position:relative;" onclick=\'hcSQuery.SQueryEditorUI._addFilterFromUI(false,'+i.tempId+")'>Add condition</button>",r+=e?"</div>":'<button title="Add new condition group: hold down Shift to convert existing conditions to group" class="SQuerySearchButton" type="button" style="left:4px;bottom:2px;position:relative;" onclick=\'!hcSQuery.SQueryEditorUI.shiftPressed ? hcSQuery.SQueryEditorUI._addFilterFromUI(true,'+i.tempId+") : hcSQuery.SQueryEditorUI._convertToChildfilter(true,"+i.tempId+")'>Add condition group</button>",r}}class c{static _updatedCallback=null;static _showButtonRow=!0;static initialize(e,t,i){c._manager=t,c._viewer=t._viewer,c._table=null,c._uidiv=e,c._showButtonRow&&($("#"+c._uidiv).append('<button title = "Add search to SQuery Manager" class="SQuerySearchButton" id="SQueryManagerAddCurrentFilter" type="button" style="top:2px">Add</button>'),$("#"+c._uidiv).append('<button title = "Execute all queries" class="SQuerySearchButton" id="SQueryManagerExecute" type="button" style="top:2px;margin-left:2px;">Execute</button>'),i&&($("#"+c._uidiv).append('<button class="SQuerySearchButton" id="SQueryManagerExport" type="button" style="position:absolute;right:0px;top:2px">Export</button>'),$("#"+c._uidiv).append('<button class="SQuerySearchButton" id="SQueryManagerUpload" type="button" style="position:absolute;right:52px;top:2px">Load</button><input style="display:none" type="file" id="inputupload">'),$("#SQueryManagerExport").click((function(){c.exportToFile("squeryfilters.json")})),$("#SQueryManagerUpload").click((function(e){e.preventDefault(),$("#inputupload").trigger("click")})),$("#inputupload").change((function(){let e=$("#inputupload")[0].files;e.length>0&&c.load(e[0])}))),$("#SQueryManagerAddCurrentFilter").click((function(){c._addCurrentFilter()})),$("#SQueryManagerExecute").click((function(){c._executeAllFilters()}))),$("#"+this._uidiv).append('<div id="'+c._uidiv+'Tabulator" class = "SQueryManagerTabulator"></div>'),c.refreshUI()}static setUpdatedCallback(e){c._updatedCallback=e}static async load(e){let t=new FileReader;t.onload=async function(e){let t=JSON.parse(e.target.result);c._manager.fromJSON(t),c.refreshUI()},t.readAsText(e)}static _generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}static async _executeAllFilters(){c._manager.executeSQueries()}static async _addCurrentFilter(){u.updateFilterFromUI();let e=u.getFilter().toJSON(),t=new hcSQuery.SQuery(c._manager);t.fromJSON(e),t._id=c._generateGUID(),t.setName(""),c._manager.addSQuery(t,!1);let i={};i.id=t._id,i.description=t.getName(),await c._table.addRow(i),c._updatedCallback&&c._updatedCallback()}static formatTooltip(e,t){let i=t.getData().id;return c._manager.getSQueryByID(i).generateString()}static editCheck(e){return c._editable}static async refreshUI(){if(c._table)await c._table.clearData();else{let e=[{label:"<i class='fas fa-user'></i> Select",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.selectAll()}},{label:"<i class='fas fa-user'></i> Isolate",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().isolateAll()}},{label:"<i class='fas fa-user'></i> Show",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().makeVisible(!0)}},{label:"<i class='fas fa-user'></i> Hide",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().makeVisible(!1)}},{separator:!0},{label:"<i class='fas fa-user'></i> Red",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().colorize(new Communicator.Color(255,0,0))}},{label:"<i class='fas fa-user'></i> Green",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().colorize(new Communicator.Color(0,255,0))}},{label:"<i class='fas fa-user'></i> Blue",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().colorize(new Communicator.Color(0,0,255))}},{label:"<i class='fas fa-user'></i> Yellow",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().colorize(new Communicator.Color(255,255,0))}},{label:"<i class='fas fa-user'></i> Grey",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().colorize(new Communicator.Color(128,128,128))}},{label:"<i class='fas fa-user'></i> Transparent",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().setOpacity(.25)}},{label:"<i class='fas fa-user'></i> Opaque",action:async function(e,t){await c._updateEditor(t.getData().id),await u.search(),u.getFoundItems().setOpacity(1)}},{separator:!0},{label:"<i class='fas fa-user'></i> View",action:async function(e,t){let i=t.getData(),r=c._manager.getSQueryByID(i.id).toJSON();u.getFilter().fromJSON(r),u.clearSearchResults(),await u.refreshUI()}},{label:"<i class='fas fa-user'></i> Edit Name",action:async function(e,t){c._editable=!0}},{label:"<i class='fas fa-user'></i> Update",action:async function(e,t){c._handleSQueryUpdate(t)}},{label:"<i class='fas fa-user'></i> Delete",action:async function(e,t){c._manager.removeSQuery(t.getData().id),t.delete(),c._updatedCallback&&c._updatedCallback()}}],t=function(e,t,i){if(null==e.getValue())return e.getValue();switch(e.getValue()){case"red":return'<div style="background:red;color:red;width:100%;height:calc(100% - 4px);margin-bottom:3px"></div>';case"green":return'<div style="background:green;color:green;width:100%;height:calc(100% - 4px);margin-bottom:3px"></div>';case"blue":return'<div style="background:blue;color:blue;width:100%;height:calc(100% - 4px);margin-bottom:3px"></div>';case"yellow":return'<div style="background:yellow;color:yellow;width:100%;height:calc(100% - 4px);margin-bottom:3px"></div>';case"grey":return'<div style="background:grey;color:grey;width:100%;height:calc(100% - 4px);margin-bottom:3px"></div>';default:return e.getValue()}},i=function(e,t,i,r){switch(t){case"red":return'<span style="background:red;color:red">XXXXXXXXX</span>';case"green":return'<span style="background:green;color:green">XXXXXXXXX</span>';case"blue":return'<span style="background:blue;color:blue">XXXXXXXXX</span>';case"yellow":return'<span style="background:yellow;color:yellow">XXXXXXXXX</span>';case"grey":return'<span style="background:grey;color:grey">XXXXXXXXX</span>';case"":return"None";default:return t}},r=["","Isolate","Show","Hide","Select","Auto Color","red","green","blue","yellow","grey","Transparent","Opaque"];c._table=new Tabulator("#"+c._uidiv+"Tabulator",{data:[],selectable:0,rowHeight:17,movableRows:!0,layout:"fitColumns",rowContextMenu:e,columns:[{title:"Name",headerSort:!1,field:"description",formatter:"textarea",editor:"input",editable:c.editCheck,tooltip:c.formatTooltip},{title:"ID",field:"id",width:20,visible:!1},{title:"Action1",headerSort:!1,field:"action0",editor:"list",width:50,formatter:t,editorParams:{values:r,itemFormatter:i}},{title:"Action2",headerSort:!1,field:"action1",editor:"list",width:50,formatter:t,editorParams:{values:r,itemFormatter:i}},{title:"Prop",headerSort:!1,field:"prop",width:50,hozAlign:"center",formatter:"tickCross",sorter:"boolean",editor:!0,editorParams:{tristate:!1}}]}),c._table.on("rowClick",(async function(e,t){let i=t.getData(),r=c._manager.getSQueryByID(i.id),o=r.toJSON();u.getFilter().fromJSON(o),u.clearSearchResults(),await u.refreshUI(),r.hasAction()?await u.search(!0):await u.search()})),c._table.on("rowDblClick",(function(e,t){c._editable=!0})),c._table.on("rowMoved",(function(e){let t=c._table.getRows(),i=[];for(let e=0;e<t.length;e++){let r=t[e].getData();i.push(c._manager.getSQueryByID(r.id))}c._manager.setSQueries(i)})),c._table.on("cellEdited",(function(e){"description"==e.getField()?(c._handleSQueryNameEdit(e.getRow()),c._editable=!1):"prop"==e.getField()?c._handleSQueryIsPropEdit(e.getRow()):"action0"==e.getField()?c._handleSQueryIsActionEdit(e.getRow(),0):"action1"==e.getField()&&c._handleSQueryIsActionEdit(e.getRow(),1),c._table.redraw()}))}for(let e=0;e<c._manager.getSQueryNum();e++){let t,i=c._manager.getSQuery(e);t=""==i.getName()?i.generateString():i.getName();let r={};t=t.replace(/&quot;/g,'"'),r.id=c._manager.getSQueryID(e),r.description=t,r.action0=i.getAction(0),r.action1=i.getAction(1),r.prop=c._manager.getSQuery(e).getProp(),await c._table.addRow(r)}}static async _updateEditor(e){let t=c._manager.getSQueryByID(e).toJSON();u.getFilter().fromJSON(t),await u.refreshUI()}static async _handleSQueryNameEdit(e){let t=e.getData(),i=c._manager.getSQueryByID(t.id);i.setName(t.description),""==t.description&&e.update({description:i.getName()}),c._updatedCallback&&c._updatedCallback()}static async _handleSQueryIsPropEdit(e){let t=e.getData();c._manager.updateSQueryIsProp(t.id,t.prop),c._updatedCallback&&c._updatedCallback()}static async _handleSQueryIsActionEdit(e,t){let i=e.getData(),r=c._manager.getSQueryByID(i.id);0==t?r.setAction(i.action0,0):r.setAction(i.action1,1),c._updatedCallback&&c._updatedCallback()}static _handleSQueryUpdate(e){let t=e.getData(),i=c._manager.getSQueryByID(t.id);u.updateFilterFromUI();let r=u.getFilter().toJSON(),o=new hcSQuery.SQuery(c._manager);o.fromJSON(r),i.updateConditions(o._conditions),i.setAutoColors(o.getAutoColors(),o.getAutoColorProperty()),i.setName(""),e.update({description:i.getName()}),c._updatedCallback&&c._updatedCallback()}static exportToFile(e){let t=JSON.stringify(c._manager.toJSON()),i=document.createElement("a");i.setAttribute("download",e),i.href=function(e){let t=new Blob([e],{type:"text/plain"});return window.URL.createObjectURL(t)}(t),document.body.appendChild(i),window.requestAnimationFrame((function(){let e=new MouseEvent("click");i.dispatchEvent(e),document.body.removeChild(i)}))}}class p{static initialize(e,t){p._table=null,p._manager=t,p._viewer=t._viewer,p._uidiv=e,p._viewer.setCallbacks({selectionArray:function(e,t){p._itemSelected()}}),$("#"+this._uidiv).append('<div id="'+p._uidiv+'Tabulator" class="squeryPropertiesTabulator"></div>'),p._refreshUI()}static async _refreshUI(){p._table?await p._table.clearData():p._table=new Tabulator("#"+p._uidiv+"Tabulator",{data:[],dataTree:!0,dataTreeStartExpanded:!0,selectable:1,layout:"fitColumns",columns:[{title:"Name",field:"name"},{title:"Value",field:"value"},{title:"ID",field:"id",width:20,visible:!1}]})}static async _itemSelected(){let e=p._viewer.selectionManager.getResults();if(await p._table.clearData(),e.length>0){let t=e[0].getNodeId(),i=await p._manager.evaluateProperties(t),r=0;for(let e=0;e<i.length;e++){let t=i[e].properties;if(0==t.length){let t={};t.id=r++,t.name=i[e].name,t.value="true",await p._table.addRow(t)}else if(1==t.length){let o={};o.id=r++,o.name=i[e].name,o.value=t[0].name+":"+t[0].value,await p._table.addRow(o)}else{let o={};o.id=r++,o.name=i[e].name;let a=[];for(let e=0;e<t.length;e++){let i={};i.id=r++,i.name=t[e].name,i.value=t[e].value,a.push(i)}o._children=a,await p._table.addRow(o)}}}}}function h(){return"1.1.0"}hcSQuery=t})();